# Glory-Hole DNS Configuration: Advanced Policy-Based Filtering
#
# This configuration demonstrates advanced filtering capabilities:
# - Complex time-based rules
# - IP-based access control
# - Multi-condition logic
# - Granular domain matching

server:
  listen_address: ":53"
  tcp_enabled: true
  udp_enabled: true
  web_ui_address: ":8080"
  cors_allowed_origins: []

# Authentication (optional for advanced setups)
auth:
  enabled: false
  username: "admin"
  password_hash: ""
  api_key: ""

upstream_dns_servers:
  - "1.1.1.1:53"
  - "8.8.8.8:53"

update_interval: "24h"
auto_update_blocklists: true

# Minimal blocklists - rely on policy engine for filtering
blocklists:
  - "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"

# Advanced Policy Engine Rules
policy:
  enabled: true
  rules:
    # ===== Time-Based Rules =====

    # Weekend mode: Allow everything on weekends
    - name: "Weekend freedom"
      logic: '!Weekday'
      action: "allow"
      enabled: true

    # Lunch break (12 PM - 1 PM): Allow social media
    - name: "Lunch break social media"
      logic: 'Weekday && Hour >= 12 && Hour < 13 && (DomainMatches(Domain, "facebook") || DomainMatches(Domain, "twitter"))'
      action: "allow"
      enabled: true

    # After hours (6 PM - 9 AM): Block work-related sites
    - name: "After hours work block"
      logic: 'Weekday && (Hour >= 18 || Hour < 9) && (DomainMatches(Domain, "slack") || DomainMatches(Domain, "asana") || DomainMatches(Domain, "jira"))'
      action: "block"
      enabled: true

    # ===== IP-Based Rules =====

    # Guest network: Very restrictive
    - name: "Guest network restrictions"
      logic: 'IPInCIDR(ClientIP, "192.168.2.0/24") && (DomainMatches(Domain, "facebook") || DomainMatches(Domain, "netflix") || DomainMatches(Domain, "gaming"))'
      action: "block"
      enabled: true

    # Admin network: Full access
    - name: "Admin bypass all filters"
      logic: 'IPInCIDR(ClientIP, "10.0.0.0/28")'
      action: "allow"
      enabled: true

    # Kids network: Strict filtering
    - name: "Kids network - block social"
      logic: 'IPInCIDR(ClientIP, "192.168.3.0/24") && (DomainMatches(Domain, "social") || DomainMatches(Domain, "chat") || DomainMatches(Domain, "discord"))'
      action: "block"
      enabled: true

    # ===== Complex Multi-Condition Rules =====

    # Block video streaming during work hours, except for trusted IPs
    - name: "Smart streaming block"
      logic: 'Weekday && Hour >= 9 && Hour < 17 && !IPInCIDR(ClientIP, "10.0.0.0/24") && (DomainMatches(Domain, "youtube") || DomainMatches(Domain, "netflix") || DomainMatches(Domain, "twitch"))'
      action: "block"
      enabled: true

    # Block downloads during peak hours (9 AM - 11 AM, 1 PM - 3 PM)
    - name: "Peak hours download block"
      logic: 'Weekday && ((Hour >= 9 && Hour < 11) || (Hour >= 13 && Hour < 15)) && (DomainMatches(Domain, "torrent") || DomainMatches(Domain, "download") || DomainEndsWith(Domain, ".exe"))'
      action: "block"
      enabled: true

    # ===== Domain Pattern Rules =====

    # Block specific TLDs that are commonly used for spam
    - name: "Block suspicious TLDs"
      logic: 'DomainEndsWith(Domain, ".xyz") || DomainEndsWith(Domain, ".top") || DomainEndsWith(Domain, ".click")'
      action: "block"
      enabled: false  # Be careful with this, some legitimate sites use these

    # Block subdomains of blocked domains
    - name: "Block all Facebook subdomains"
      logic: 'DomainEndsWith(Domain, ".facebook.com") || DomainEndsWith(Domain, ".fbcdn.net") || DomainEndsWith(Domain, ".fb.me")'
      action: "block"
      enabled: false

    # Allow specific subdomains
    - name: "Allow work-related Google services"
      logic: '(DomainMatches(Domain, "drive.google") || DomainMatches(Domain, "docs.google") || DomainMatches(Domain, "gmail")) && IPInCIDR(ClientIP, "10.0.1.0/24")'
      action: "allow"
      enabled: true

    # ===== Query Type Rules =====

    # You can also combine with query type (though not directly exposed yet)
    # Example: Block all queries from specific network
    - name: "IoT network - only allow DNS for monitoring"
      logic: 'IPInCIDR(ClientIP, "192.168.4.0/24") && !DomainMatches(Domain, "monitoring") && !DomainMatches(Domain, "metrics")'
      action: "block"
      enabled: false

    # ===== REDIRECT Action Examples =====

    # Redirect blocked sites to a captive portal
    - name: "Redirect gambling sites to warning page"
      logic: 'DomainMatches(Domain, "casino") || DomainMatches(Domain, "poker")'
      action: "redirect"
      action_data: "192.168.1.254"  # IP of captive portal/warning page
      enabled: false  # Example only

    # Redirect ads to blackhole IP
    - name: "Redirect ad domains to 0.0.0.0"
      logic: 'DomainMatches(Domain, "doubleclick") || DomainMatches(Domain, "googlesyndication")'
      action: "redirect"
      action_data: "0.0.0.0"  # Blackhole IP
      enabled: false  # Use blocklist instead for better performance

    # Redirect specific domain to internal server
    - name: "Redirect external service to internal mirror"
      logic: 'Domain == "example.com" && IPInCIDR(ClientIP, "10.0.0.0/8")'
      action: "redirect"
      action_data: "10.0.1.100"  # Internal mirror server
      enabled: false  # Example only

    # ===== Catchall Rules =====

    # ===== Advanced Helper Functions Examples =====

    # Use regex for complex domain patterns
    - name: "Block CDN domains with numbers"
      logic: 'DomainRegex(Domain, "^cdn\\d+\\.")'
      action: "block"
      enabled: false  # Example only

    # Filter by subdomain depth
    - name: "Block deep subdomains (>4 levels)"
      logic: 'DomainLevelCount(Domain) > 4'
      action: "block"
      enabled: false  # Example: blocks "a.b.c.d.e.com" but not "www.example.com"

    # Match specific IP addresses
    - name: "Allow specific admin IP"
      logic: 'IPEquals(ClientIP, "192.168.1.100")'
      action: "allow"
      enabled: false

    # Filter by query type
    - name: "Block all MX and TXT queries"
      logic: 'QueryTypeIn(QueryType, "MX", "TXT", "SOA")'
      action: "block"
      enabled: false  # Example only

    # Use IsWeekend for cleaner weekend checks
    - name: "Relax filtering on weekends"
      logic: 'IsWeekend(Weekday) && DomainMatches(Domain, "gaming")'
      action: "allow"
      enabled: false

    # Precise time ranges with minutes
    - name: "Block social media during study hours"
      logic: 'InTimeRange(Hour, Minute, 19, 30, 22, 0) && DomainMatches(Domain, "social")'
      action: "block"
      enabled: false  # Example: blocks 7:30 PM - 10:00 PM

    # Complex example combining multiple new helpers
    - name: "Advanced combined rule"
      logic: 'DomainLevelCount(Domain) >= 3 && QueryTypeIn(QueryType, "A", "AAAA") && !IsWeekend(Weekday) && InTimeRange(Hour, Minute, 9, 0, 17, 30)'
      action: "block"
      enabled: false  # Example: blocks subdomains during work hours on weekdays

    # Default allow (place last) - if no other rule matches
    - name: "Default allow"
      logic: 'true'
      action: "allow"
      enabled: false  # Only enable if you want explicit default

# Local records for testing
local_records:
  enabled: true
  records:
    - domain: "test.local"
      type: "A"
      ips: ["127.0.0.1"]

    - domain: "blocked.test.local"
      type: "A"
      ips: ["0.0.0.0"]

# High-performance cache
cache:
  enabled: true
  max_entries: 10000
  min_ttl: "60s"
  max_ttl: "24h"
  negative_ttl: "5m"

# Detailed logging for rule debugging
database:
  enabled: true
  backend: "sqlite"
  sqlite:
    path: "./policy-logs.db"
  buffer_size: 1000
  flush_interval: "5s"
  retention_days: 7

logging:
  level: "debug"  # See policy evaluation details
  format: "json"
  output: "stdout"
  add_source: true

telemetry:
  enabled: true
  prometheus_enabled: true
  prometheus_port: 9090

# Helper Functions Available in Policy Rules:
#
# Domain Matching Functions:
#   DomainMatches(Domain, "substring") - Check if domain contains substring
#     Example: DomainMatches(Domain, "google") matches "www.google.com"
#
#   DomainEndsWith(Domain, "suffix") - Check if domain ends with suffix
#     Example: DomainEndsWith(Domain, ".com") matches "example.com"
#
#   DomainStartsWith(Domain, "prefix") - Check if domain starts with prefix
#     Example: DomainStartsWith(Domain, "www.") matches "www.example.com"
#
#   DomainRegex(Domain, "pattern") - Match domain against regex pattern
#     Example: DomainRegex(Domain, "^cdn\\d+\\.") matches "cdn123.example.com"
#
#   DomainLevelCount(Domain) - Count subdomain levels (returns integer)
#     Example: DomainLevelCount("www.example.com") returns 3
#
# IP Matching Functions:
#   IPInCIDR(ClientIP, "cidr") - Check if IP is in CIDR range
#     Example: IPInCIDR(ClientIP, "192.168.1.0/24")
#
#   IPEquals(IP1, IP2) - Check if two IPs are equal (handles IPv4/IPv6)
#     Example: IPEquals(ClientIP, "192.168.1.100")
#
# Query Type Functions:
#   QueryTypeIn(QueryType, "type1", "type2", ...) - Check if query type matches any in list
#     Example: QueryTypeIn(QueryType, "A", "AAAA") matches A or AAAA queries
#
# Time Functions:
#   IsWeekend(Weekday) - Check if day is Saturday or Sunday
#     Example: IsWeekend(Weekday) returns true on weekends
#
#   InTimeRange(Hour, Minute, StartH, StartM, EndH, EndM) - Check if time in range
#     Example: InTimeRange(Hour, Minute, 9, 0, 17, 30) matches 9:00 AM - 5:30 PM
#     Note: Handles overnight ranges (e.g., 23:00 - 02:00)
#
# Variables Available:
#   Domain     - The queried domain (e.g., "www.example.com")
#   ClientIP   - The IP of the DNS client
#   QueryType  - The DNS query type (e.g., "A", "AAAA", "CNAME")
#   Hour       - Current hour (0-23)
#   Minute     - Current minute (0-59)
#   Day        - Day of month (1-31)
#   Month      - Month (1-12)
#   Weekday    - Day of week (0-6, Sunday=0)
#   Time       - Full timestamp
#
# Actions Available:
#   BLOCK      - Return NXDOMAIN (domain not found)
#   ALLOW      - Bypass all filtering and forward to upstream
#   REDIRECT   - Return a specific IP address instead of real resolution
#                Requires action_data field with target IP
#                Example: action_data: "0.0.0.0" (blackhole)
#                         action_data: "192.168.1.254" (captive portal)
#                Supports both IPv4 and IPv6
