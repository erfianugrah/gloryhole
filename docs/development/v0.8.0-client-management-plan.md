# Glory-Hole v0.8.0 - Client Management

**Version:** 0.8.0
**Type:** Major Feature Release
**Target Date:** Q1 2025
**Status:** Planning

---

## Overview

Implement comprehensive client management capabilities including auto-discovery, tracking, profiles, and per-client statistics. This is the foundation for group-based policies and advanced network management.

---

## Objectives

1. ğŸ¯ **Client Discovery**: Automatically detect and track network devices
2. ğŸ“Š **Client Statistics**: Per-client query counts, top domains, blocked queries
3. ğŸ‘¤ **Client Profiles**: Friendly names, device types, metadata
4. ğŸ” **Client Monitoring**: Real-time client activity tracking
5. ğŸ–¥ï¸ **Client Management UI**: View and manage clients via web interface

---

## Architecture

### Data Model

```go
// pkg/clients/client.go
type Client struct {
    ID            string    `json:"id"`           // UUID
    IPAddress     string    `json:"ip_address"`   // Primary identifier
    MACAddress    string    `json:"mac_address"`  // Optional (from ARP)
    Hostname      string    `json:"hostname"`     // From DNS queries or mDNS
    FriendlyName  string    `json:"friendly_name"` // User-assigned
    DeviceType    DeviceType `json:"device_type"`  // phone, tablet, computer, iot, etc.
    Owner         string    `json:"owner"`        // Optional user/person
    GroupID       string    `json:"group_id"`     // For future group management
    Icon          string    `json:"icon"`         // Icon identifier
    Notes         string    `json:"notes"`        // User notes
    FirstSeen     time.Time `json:"first_seen"`
    LastSeen      time.Time `json:"last_seen"`
    Active        bool      `json:"active"`       // Recently seen?
    Metadata      map[string]string `json:"metadata"` // Custom key-value pairs
}

type DeviceType string

const (
    DeviceTypeUnknown    DeviceType = "unknown"
    DeviceTypeComputer   DeviceType = "computer"
    DeviceTypePhone      DeviceType = "phone"
    DeviceTypeTablet     DeviceType = "tablet"
    DeviceTypeIoT        DeviceType = "iot"
    DeviceTypeServer     DeviceType = "server"
    DeviceTypeRouter     DeviceType = "router"
    DeviceTypeTV         DeviceType = "tv"
    DeviceTypeGameConsole DeviceType = "game_console"
    DeviceTypePrinter    DeviceType = "printer"
)

// pkg/clients/stats.go
type ClientStats struct {
    ClientID       string    `json:"client_id"`
    TotalQueries   int64     `json:"total_queries"`
    BlockedQueries int64     `json:"blocked_queries"`
    AllowedQueries int64     `json:"allowed_queries"`
    TopDomains     []DomainCount `json:"top_domains"`
    TopBlocked     []DomainCount `json:"top_blocked"`
    LastUpdated    time.Time `json:"last_updated"`
}

type DomainCount struct {
    Domain string `json:"domain"`
    Count  int64  `json:"count"`
}
```

### Components

```
pkg/clients/
â”œâ”€â”€ client.go           # Client data model and core types
â”œâ”€â”€ manager.go          # Client management (CRUD operations)
â”œâ”€â”€ discovery.go        # Auto-discovery (passive from DNS queries)
â”œâ”€â”€ arp.go             # MAC address lookup via ARP
â”œâ”€â”€ mdns.go            # mDNS/Bonjour discovery (optional)
â”œâ”€â”€ stats.go           # Per-client statistics
â”œâ”€â”€ tracker.go         # Real-time activity tracking
â””â”€â”€ persistence.go     # Database storage for clients

pkg/storage/
â””â”€â”€ clients.go         # Client database operations (SQLite)

pkg/api/
â””â”€â”€ handlers_clients.go # REST API handlers for clients

web/templates/
â””â”€â”€ clients.html       # Web UI for client management
```

---

## Features

### 1. Client Discovery

#### Passive Discovery (Primary Method)
- **DNS Query Tracking**: Extract client IP from every DNS query
- **First Seen**: Record timestamp of first DNS query
- **Last Seen**: Update on every query
- **Hostname Detection**: Capture reverse DNS lookups and mDNS queries

**Implementation:**
```go
// In DNS handler
func (h *Handler) ServeDNS(ctx context.Context, w dns.ResponseWriter, req *dns.Msg) {
    clientIP := extractClientIP(w.RemoteAddr())

    // Update client tracker
    h.ClientManager.RecordActivity(clientIP, req.Question[0].Name)

    // Continue with DNS handling...
}
```

#### Active Discovery (Optional)
- **ARP Scanning**: Lookup MAC addresses for known IPs
- **mDNS/Bonjour**: Discover device names on local network
- **ICMP Ping**: Verify device is still active

**Configuration:**
```yaml
clients:
  enabled: true
  discovery:
    passive: true          # Always enabled when clients enabled
    arp_lookup: true       # Lookup MAC addresses
    mdns_lookup: false     # mDNS discovery (can be noisy)
    activity_timeout: "5m" # Mark inactive after 5 min no queries
```

### 2. Client Profiles

#### User-Editable Fields
- **Friendly Name**: "John's iPhone", "Kitchen Alexa"
- **Device Type**: Select from predefined types + custom
- **Owner**: Person responsible for device
- **Icon**: Visual identifier in UI
- **Notes**: Free-form text notes

#### Auto-Detected Fields
- **IP Address**: Primary identifier
- **MAC Address**: From ARP (if available)
- **Hostname**: From DNS queries, reverse DNS, mDNS
- **First Seen / Last Seen**: Timestamps

**API:**
```go
// GET /api/clients
// List all clients
func (a *API) ListClients(w http.ResponseWriter, r *http.Request) {
    clients := a.ClientManager.GetAll()
    writeJSON(w, clients)
}

// GET /api/clients/{id}
// Get single client
func (a *API) GetClient(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")
    client := a.ClientManager.Get(id)
    writeJSON(w, client)
}

// PUT /api/clients/{id}
// Update client profile
func (a *API) UpdateClient(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")
    var update ClientUpdate
    if err := json.NewDecoder(r.Body).Decode(&update); err != nil {
        writeError(w, err)
        return
    }

    client := a.ClientManager.Update(id, update)
    writeJSON(w, client)
}

// DELETE /api/clients/{id}
// Remove client (soft delete, mark as ignored)
func (a *API) DeleteClient(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")
    a.ClientManager.Delete(id)
    writeJSON(w, map[string]string{"status": "deleted"})
}
```

### 3. Client Statistics

#### Per-Client Metrics
- **Query Count**: Total DNS queries from this client
- **Blocked Count**: Queries blocked by blocklists/policies
- **Allowed Count**: Queries that were allowed
- **Top Domains**: Most queried domains
- **Top Blocked**: Most blocked domains
- **Query Types**: Distribution of A, AAAA, CNAME, etc.
- **Time Series**: Query volume over time

**Implementation:**
```go
// pkg/clients/stats.go
type StatsCollector struct {
    clients map[string]*ClientStats
    mu      sync.RWMutex
}

func (s *StatsCollector) RecordQuery(clientIP string, domain string, blocked bool) {
    s.mu.Lock()
    defer s.mu.Unlock()

    stats, exists := s.clients[clientIP]
    if !exists {
        stats = &ClientStats{ClientID: clientIP}
        s.clients[clientIP] = stats
    }

    stats.TotalQueries++
    if blocked {
        stats.BlockedQueries++
    } else {
        stats.AllowedQueries++
    }

    // Update top domains
    s.updateTopDomains(stats, domain, blocked)
}
```

**API:**
```go
// GET /api/clients/{id}/stats
// Get client statistics
func (a *API) GetClientStats(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")
    stats := a.ClientManager.GetStats(id)
    writeJSON(w, stats)
}

// GET /api/clients/{id}/queries
// Get recent queries from client
func (a *API) GetClientQueries(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")
    limit := parseInt(r.URL.Query().Get("limit"), 100)
    since := parseTime(r.URL.Query().Get("since"), time.Now().Add(-24*time.Hour))

    queries := a.Storage.GetClientQueries(id, since, limit)
    writeJSON(w, queries)
}
```

### 4. Client Monitoring

#### Real-Time Activity
- **Active Clients**: Currently making queries (within timeout window)
- **Inactive Clients**: No queries in last N minutes
- **Activity Feed**: Live stream of client queries (WebSocket)

#### Alerts (Future)
- Client made first query (new device on network)
- Client inactive for extended period
- Client excessive query rate
- Client attempting to access blocked content

### 5. Web UI

#### Client List View
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clients                                    [+ Add Manual] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Search: [_______] Filter: [All â–¼] Sort: [Name â–¼]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“± John's iPhone                     Active â€¢ 192.168.1.100â”‚
â”‚    234 queries â€¢ 12 blocked â€¢ Last seen 2 min ago       â”‚
â”‚                                                          â”‚
â”‚ ğŸ’» MacBook Pro                      Active â€¢ 192.168.1.101â”‚
â”‚    1.2K queries â€¢ 45 blocked â€¢ Last seen 5 min ago      â”‚
â”‚                                                          â”‚
â”‚ ğŸ  Living Room Echo              Inactive â€¢ 192.168.1.105â”‚
â”‚    89 queries â€¢ 3 blocked â€¢ Last seen 2 hours ago       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Client Detail View
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Back to Clients                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“± John's iPhone                                   [Edit] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Details                                                  â”‚
â”‚   IP Address:    192.168.1.100                          â”‚
â”‚   MAC Address:   aa:bb:cc:dd:ee:ff                      â”‚
â”‚   Hostname:      Johns-iPhone.local                     â”‚
â”‚   Device Type:   Phone                                   â”‚
â”‚   Owner:         John                                    â”‚
â”‚   First Seen:    2025-01-15 14:23:45                    â”‚
â”‚   Last Seen:     2 minutes ago                          â”‚
â”‚                                                          â”‚
â”‚ Statistics (Last 24h)                                    â”‚
â”‚   Total Queries:   234                                   â”‚
â”‚   Blocked:         12 (5.1%)                            â”‚
â”‚   Allowed:         222 (94.9%)                          â”‚
â”‚                                                          â”‚
â”‚ Top Domains                                              â”‚
â”‚   1. apple.com                    45 queries             â”‚
â”‚   2. icloud.com                   32 queries             â”‚
â”‚   3. google.com                   28 queries             â”‚
â”‚                                                          â”‚
â”‚ Top Blocked                                              â”‚
â”‚   1. ads.example.com              5 blocks              â”‚
â”‚   2. tracker.ad.com               4 blocks              â”‚
â”‚                                                          â”‚
â”‚ Recent Queries                                           â”‚
â”‚   [Query log filtered to this client]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

```sql
-- Clients table
CREATE TABLE clients (
    id TEXT PRIMARY KEY,                    -- UUID
    ip_address TEXT UNIQUE NOT NULL,        -- Primary identifier
    mac_address TEXT,                        -- From ARP
    hostname TEXT,                           -- From DNS/mDNS
    friendly_name TEXT,                      -- User-assigned
    device_type TEXT NOT NULL DEFAULT 'unknown',
    owner TEXT,
    group_id TEXT,                           -- Foreign key to groups (future)
    icon TEXT,
    notes TEXT,
    first_seen DATETIME NOT NULL,
    last_seen DATETIME NOT NULL,
    active INTEGER NOT NULL DEFAULT 1,
    metadata TEXT,                           -- JSON for custom fields
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_clients_ip ON clients(ip_address);
CREATE INDEX idx_clients_active ON clients(active);
CREATE INDEX idx_clients_last_seen ON clients(last_seen);
CREATE INDEX idx_clients_group ON clients(group_id);

-- Client statistics (aggregated)
CREATE TABLE client_stats (
    client_id TEXT NOT NULL,
    date DATE NOT NULL,                      -- For daily aggregation
    total_queries INTEGER NOT NULL DEFAULT 0,
    blocked_queries INTEGER NOT NULL DEFAULT 0,
    allowed_queries INTEGER NOT NULL DEFAULT 0,
    PRIMARY KEY (client_id, date),
    FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE
);

CREATE INDEX idx_client_stats_date ON client_stats(date);

-- Client top domains (pre-aggregated for performance)
CREATE TABLE client_top_domains (
    client_id TEXT NOT NULL,
    date DATE NOT NULL,
    domain TEXT NOT NULL,
    query_count INTEGER NOT NULL DEFAULT 0,
    blocked INTEGER NOT NULL DEFAULT 0,     -- 1 if this is a blocked domain
    PRIMARY KEY (client_id, date, domain),
    FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE
);

CREATE INDEX idx_client_top_domains_count ON client_top_domains(client_id, query_count DESC);
```

**Query log enhancement:**
```sql
-- Add client_id to existing query_log table
ALTER TABLE query_log ADD COLUMN client_id TEXT;
CREATE INDEX idx_query_log_client ON query_log(client_id);
```

---

## Implementation Plan

### Phase 1: Core Client Management (Week 1-2)
- [ ] Create client data model
- [ ] Implement client manager (CRUD)
- [ ] Add database schema and migrations
- [ ] Implement passive discovery (from DNS queries)
- [ ] Add client persistence
- [ ] Write tests (target: 85% coverage)

### Phase 2: Statistics & Tracking (Week 3)
- [ ] Implement stats collector
- [ ] Add per-client query tracking
- [ ] Create aggregation logic (daily rollups)
- [ ] Add top domains tracking
- [ ] Link query log to clients
- [ ] Write tests

### Phase 3: Discovery Enhancements (Week 4)
- [ ] Implement ARP MAC lookup (Linux/macOS/Windows)
- [ ] Add mDNS discovery (optional)
- [ ] Implement activity tracking (active/inactive)
- [ ] Add hostname resolution
- [ ] Write tests

### Phase 4: REST API (Week 5)
- [ ] Create API handlers for clients
- [ ] Add endpoints: list, get, create, update, delete
- [ ] Add statistics endpoints
- [ ] Add query history endpoint
- [ ] Add filtering and pagination
- [ ] Write API tests

### Phase 5: Web UI (Week 6)
- [ ] Create client list template
- [ ] Create client detail template
- [ ] Add edit client form
- [ ] Add HTMX interactions
- [ ] Add real-time updates (WebSocket or SSE)
- [ ] Style with existing CSS

### Phase 6: Integration & Testing (Week 7)
- [ ] Integration tests with full stack
- [ ] Performance testing (1000+ clients)
- [ ] Memory profiling
- [ ] Load testing
- [ ] Documentation
- [ ] Example configurations

### Phase 7: Documentation & Release (Week 8)
- [ ] User guide for client management
- [ ] API documentation
- [ ] Configuration examples
- [ ] Update CHANGELOG
- [ ] Create release notes
- [ ] Tag v0.8.0

---

## Configuration Example

```yaml
# Client Management
clients:
  enabled: true

  # Discovery settings
  discovery:
    # Passive discovery from DNS queries (always on when clients enabled)
    passive: true

    # Active discovery methods
    arp_lookup: true           # Lookup MAC addresses via ARP
    arp_interval: "5m"         # How often to refresh ARP cache
    mdns_lookup: false         # mDNS/Bonjour discovery
    mdns_interval: "1h"        # How often to scan for mDNS devices

    # Activity tracking
    activity_timeout: "5m"     # Mark inactive after no queries for 5 min
    cleanup_inactive: "30d"    # Remove inactive clients after 30 days

  # Statistics
  statistics:
    enabled: true
    aggregation_interval: "1h" # How often to aggregate stats
    retention_days: 30         # Keep detailed stats for 30 days
    top_domains_count: 10      # Track top N domains per client

  # Default device type icons (optional customization)
  icons:
    phone: "ğŸ“±"
    computer: "ğŸ’»"
    tablet: "ğŸ“±"
    iot: "ğŸ "
    server: "ğŸ–¥ï¸"
```

---

## API Reference

### Endpoints

```
GET    /api/clients                    # List all clients
GET    /api/clients/{id}               # Get client details
POST   /api/clients                    # Manually add client
PUT    /api/clients/{id}               # Update client profile
DELETE /api/clients/{id}               # Remove client
GET    /api/clients/{id}/stats         # Get client statistics
GET    /api/clients/{id}/queries       # Get client query history
GET    /api/clients/{id}/activity      # Get recent activity
GET    /api/clients/active             # Get currently active clients
POST   /api/clients/{id}/forget        # Forget client (hard delete)
```

### Query Parameters

**List Clients:**
- `active=true|false` - Filter by active status
- `device_type=phone|computer|...` - Filter by device type
- `group_id=<uuid>` - Filter by group (future)
- `search=<term>` - Search name, IP, hostname
- `sort=name|last_seen|queries` - Sort field
- `order=asc|desc` - Sort order
- `limit=N` - Page size
- `offset=N` - Page offset

**Client Queries:**
- `since=<timestamp>` - Queries since timestamp
- `until=<timestamp>` - Queries until timestamp
- `limit=N` - Max results
- `blocked=true|false` - Filter by blocked status

---

## Performance Considerations

### Scalability Targets
- **1,000 clients**: Should handle easily
- **10,000 clients**: Design with this in mind
- **100,000 clients**: May need sharding/optimization

### Optimization Strategies
1. **In-Memory Cache**: Keep active clients in memory
2. **Lazy Loading**: Load stats on-demand, not with client list
3. **Aggregation**: Pre-compute daily/hourly stats
4. **Indexing**: Proper database indexes for queries
5. **Batch Updates**: Batch database writes for statistics
6. **Connection Pooling**: Reuse database connections

### Memory Budget
- **Per Client**: ~1 KB in memory (active clients only)
- **1,000 active clients**: ~1 MB
- **10,000 active clients**: ~10 MB

---

## Security Considerations

1. **PII Data**: IP addresses, MAC addresses, hostnames are sensitive
2. **Access Control**: Consider authentication for client management API
3. **Data Retention**: Allow configuration of data retention periods
4. **Privacy Mode**: Option to disable client tracking entirely
5. **Anonymization**: Option to hash IP addresses for privacy

---

## Future Enhancements (v0.9.0+)

Based on v0.8.0 foundation:

1. **Group Management** - Organize clients into groups
2. **Per-Client Policies** - Different rules per client/group
3. **Client History** - Track IP/MAC changes over time
4. **Network Topology** - Visualize network structure
5. **Device Fingerprinting** - Better device type detection
6. **Geolocation** - Show client locations on map (if public IPs)
7. **Alerts** - Notifications for client events
8. **Integration** - Export client data to monitoring systems

---

## Success Criteria

### Must Have
- âœ… Clients automatically discovered from DNS queries
- âœ… Client profiles with friendly names and metadata
- âœ… Per-client statistics (queries, blocked, top domains)
- âœ… Web UI for viewing and managing clients
- âœ… REST API for programmatic access
- âœ… 85%+ test coverage
- âœ… Works with 1,000+ clients

### Should Have
- âœ… MAC address lookup via ARP
- âœ… Activity tracking (active/inactive)
- âœ… Query history per client
- âœ… Real-time activity monitoring

### Nice to Have
- âš¡ mDNS device discovery
- ğŸ“Š Time-series statistics
- ğŸ”” Client event notifications
- ğŸ–¼ï¸ Device icons and customization

---

**Created:** 2025-11-23
**Last Updated:** 2025-11-23
**Status:** Ready for implementation after v0.7.3
