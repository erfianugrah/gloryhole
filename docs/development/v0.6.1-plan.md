# v0.6.1 Code Quality & Cleanup Release Plan

## Why v0.6.1?

**The "Legacy" Problem**: We're calling config fields "legacy" at v0.6.0, which is confusing since we're pre-1.0. We can make breaking changes guilt-free in 0.x versions!

**The Linter Problem**: We disabled 7 linters to ship v0.6.0 quickly. This created technical debt. Time to pay it down.

## Goals

1. ✅ **Clean codebase** - All linters enabled and passing
2. ✅ **Remove confusion** - Delete truly legacy config fields
3. ✅ **Better DX** - One clear way to do local DNS records
4. ✅ **Set example** - Show how to maintain quality while moving fast

## Tasks Breakdown

### Phase 1: Linter Fixes (Estimated: 4-6 hours)

#### Task 1.1: Fix fieldalignment (30-45 min)
**What**: Reorder struct fields to minimize memory padding
**Files affected**: ~9 structs across api/, storage/, policy/
**Example**:
```go
// Before (40 bytes with padding)
type Example struct {
    Name string    // 16 bytes
    Count int      // 8 bytes
    Active bool    // 1 byte + 7 bytes padding
}

// After (32 bytes)
type Example struct {
    Name string    // 16 bytes
    Count int      // 8 bytes
    Active bool    // 1 byte + 7 bytes padding → optimized
}
```
**Test**: `golangci-lint run --enable=fieldalignment --disable-all`

#### Task 1.2: Fix shadow variables (45-60 min)
**What**: Rename shadowed variables to avoid confusion
**Files affected**: storage/sqlite.go, forwarder/forwarder_test.go, telemetry/telemetry_test.go
**Example**:
```go
// Before (err shadows outer err)
err := someFunc()
if err != nil {
    err := anotherFunc()  // ❌ shadows outer err
}

// After
err := someFunc()
if err != nil {
    if innerErr := anotherFunc(); innerErr != nil {
        return innerErr
    }
}
```
**Test**: `golangci-lint run --enable=govet --disable-all`

#### Task 1.3: Fix unusedwrite (15-20 min)
**What**: Remove unused field assignments in tests
**Files affected**: logging/logger_test.go
**Example**:
```go
// Before
test := testCase{
    cfg: &config.LoggingConfig{...},  // ❌ never read
}

// After
test := testCase{
    // cfg removed - not needed
}
```
**Test**: `golangci-lint run --enable=govet --disable-all`

#### Task 1.4: Fix staticcheck SA9003 (15-20 min)
**What**: Fill in or remove empty if branches
**Files affected**: dns/server.go, config/watcher_test.go
**Example**:
```go
// Before
if err != nil {
    // TODO: handle error
}

// After (Option A: actually handle it)
if err != nil {
    logger.Warn("Error occurred", "error", err)
}

// After (Option B: ignore explicitly)
_ = err // explicitly ignoring error
```
**Test**: `golangci-lint run --enable=staticcheck --disable-all`

#### Task 1.5: Fix gosimple S1005 (10-15 min)
**What**: Remove unnecessary blank identifier assignments
**Files affected**: test/load/benchmark_test.go
**Example**:
```go
// Before
_, _ = handler.Blocklist[testDomain]  // ❌ unnecessary

// After
_ = handler.Blocklist[testDomain]  // ✓ single blank identifier
```
**Test**: `golangci-lint run --enable=gosimple --disable-all`

#### Task 1.6: Clean up unused test code (20-30 min)
**What**: Either use or delete mockUIStorage
**Files affected**: api/ui_handlers_test.go
**Options**:
- Option A: Delete if truly unused
- Option B: Write tests that use it
- Option C: Move to shared test utilities if needed elsewhere

**Test**: `golangci-lint run --enable=unused --disable-all`

#### Task 1.7: Fix goconst (15-20 min)
**What**: Extract repeated string literals to constants
**Files affected**: api/handlers.go, api/handlers_policy.go
**Example**:
```go
// Before
if r.Header.Get("HX-Request") == "true" { ... }
if accept == "true" { ... }
if flag == "true" { ... }

// After
const trueString = "true"  // or better name based on context
if r.Header.Get("HX-Request") == trueString { ... }
```
**Test**: `golangci-lint run --enable=goconst --disable-all`

### Phase 2: Config Cleanup (Estimated: 2-3 hours)

#### Task 2.1: Remove legacy config fields (45-60 min)
**Files to modify**:
- `pkg/config/config.go` - Remove Overrides, CNAMEOverrides fields
- `pkg/dns/server.go` - Remove code that reads these fields
- `pkg/dns/handler_test.go` - Update tests

**Breaking change**: YES - Document in CHANGELOG as 0.6.1 breaking change

#### Task 2.2: Update all example configs (30-45 min)
**Files to update**:
- config/config.example.yml
- config/config.blocklist-test.yml
- config/config.test.yml
- All docs/* that show config examples

**Before**:
```yaml
overrides:
  nas.local: "192.168.1.100"
cname_overrides:
  storage.local: "nas.local."
```

**After**:
```yaml
local_records:
  enabled: true
  records:
    - domain: "nas.local"
      type: "A"
      ips: ["192.168.1.100"]
    - domain: "storage.local"
      type: "CNAME"
      target: "nas.local"
```

#### Task 2.3: Update migration guide (30 min)
**File**: CHANGELOG.md
**Add**: Clear migration instructions for 0.5.x → 0.6.1

### Phase 3: Testing & Release (Estimated: 1-2 hours)

#### Task 3.1: Run full test suite
```bash
go test -race ./...
golangci-lint run
go build ./cmd/glory-hole
docker build .
```

#### Task 3.2: Update CHANGELOG
**File**: CHANGELOG.md
```markdown
## [0.6.1] - 2025-11-22

### Fixed
- Re-enabled all linters and fixed code quality issues
- Fixed 9 fieldalignment issues (memory optimization)
- Fixed 7 variable shadowing issues (clarity)
- Fixed 3 unusedwrite issues (test cleanup)
- Fixed 2 staticcheck SA9003 issues (empty branches)
- Fixed 1 gosimple S1005 issue (benchmark code)
- Removed unused test mock code

### Changed (BREAKING)
- **Removed legacy config fields**: `overrides` and `cname_overrides`
- Use `local_records` instead (more powerful, supports IPv6, wildcards, multiple IPs)
- See migration guide below

### Migration Guide
```yaml
# Old (0.6.0 and earlier)
overrides:
  nas.local: "192.168.1.100"
cname_overrides:
  storage.local: "nas.local."

# New (0.6.1+)
local_records:
  enabled: true
  records:
    - domain: "nas.local"
      type: "A"
      ips: ["192.168.1.100"]
    - domain: "storage.local"
      type: "CNAME"
      target: "nas.local"
```
```

#### Task 3.3: Create release
```bash
git tag -a v0.6.1 -m "Code quality and config cleanup release"
git push origin v0.6.1
# CI/CD will handle the rest!
```

## Total Estimated Time: 7-11 hours

**Breakdown**:
- Linter fixes: 4-6 hours
- Config cleanup: 2-3 hours
- Testing & release: 1-2 hours

## After v0.6.1: Phase 3 Planning

### Option A: DNS-over-HTTPS (DoH)
**Pros**:
- Modern standard (RFC 8484)
- Browser support
- Privacy enhancement
- Marketable feature

**Estimated effort**: 2-3 weeks
**Complexity**: Medium

### Option B: Advanced Analytics Dashboard
**Pros**:
- Visual appeal
- Shows off performance
- User-requested
- Good for demos/marketing

**Estimated effort**: 2-3 weeks
**Complexity**: Medium

### Option C: Geographic DNS
**Pros**:
- CDN-like routing
- Performance optimization
- Unique feature

**Estimated effort**: 3-4 weeks
**Complexity**: High

### Recommendation: Start with DoH (Option A)
**Why**:
1. Clear RFC specification
2. Existing Go libraries (e.g., `m13253/dns-over-https`)
3. Complements existing DNS features
4. Opens door to mobile clients
5. Good stepping stone to DoT

## Next Steps

1. **Review this plan** - Make sure you agree with approach
2. **Start Task 1.1** - Fix fieldalignment (quick win)
3. **Commit incrementally** - One linter at a time
4. **Test continuously** - Don't batch commits
5. **Release v0.6.1** - Clean slate for Phase 3
6. **Plan Phase 3 sprint** - Choose DoH, Analytics, or GeoIP

## Questions to Decide

1. **Breaking change acceptable?** - Remove overrides/cname_overrides?
   - IMO: Yes, we're 0.x, this is the time to break things

2. **All linters or partial?** - Fix everything or just critical?
   - IMO: Fix everything, set the bar high

3. **Phase 3 priority?** - DoH, Analytics, or GeoIP?
   - IMO: DoH, but your call!
