# v0.9 Production Readiness Plan

## Overview
Prepare glory-hole for production deployment by addressing performance bottlenecks, improving code maintainability through refactoring, removing technical debt, and increasing test coverage in critical areas.

**Goal**: Production-ready v0.9 with improved performance, better code organization, and comprehensive test coverage.

**Estimated Effort**: 5-7 developer days

---

## Phase 1: Performance & Critical Fixes (HIGH PRIORITY)

### 1.1 Fix Whitelist Performance Bottleneck (TD-002)
**File**: `pkg/dns/server.go` lines 833-876
**Issue**: Exact-match whitelist uses RWMutex while blocklist is lock-free
**Impact**: Performance bottleneck during high query load

**Implementation**:
- Create new `WhitelistManager` struct using atomic pointer pattern (mirror `BlocklistManager`)
- Use `atomic.Pointer[map[string]struct{}]` for lock-free reads
- Implement `Update()`, `IsWhitelisted()`, and `Get()` methods
- Update `Server` struct to use `WhitelistManager` instead of direct map
- Migrate whitelist loading logic from `dns/server.go` to new manager
- Update all whitelist checks to use atomic load pattern

**Files to Create/Modify**:
- Create: `pkg/dns/whitelist_manager.go` (~150 lines)
- Modify: `pkg/dns/server.go` (remove lines 54-56, 833-876)
- Modify: `pkg/dns/server.go` (update initialization and handler)
- Create: `pkg/dns/whitelist_manager_test.go` (~200 lines)

**Testing**: Benchmark comparison of old vs new implementation under load

**Estimated Time**: 6-8 hours

---

### 1.2 Add Package-Level Documentation
**Impact**: Improves godoc readability and developer onboarding

**Files to Update** (add `// Package xyz provides...` comment to first file in each package):
1. `pkg/api/server.go` - REST API and HTMX UI server
2. `pkg/blocklist/manager.go` - Lock-free blocklist management
3. `pkg/cache/cache.go` - Sharded LRU DNS response cache
4. `pkg/config/config.go` - YAML configuration with hot-reload
5. `pkg/dns/server.go` - Core DNS server implementation
6. `pkg/forwarder/forwarder.go` - Upstream DNS forwarding with conditional rules
7. `pkg/localrecords/manager.go` - Authoritative local DNS records
8. `pkg/logging/logger.go` - Structured logging wrapper
9. `pkg/policy/engine.go` - Expression-based DNS policy engine
10. `pkg/ratelimit/ratelimit.go` - Token bucket rate limiting
11. `pkg/resolver/resolver.go` - Centralized DNS resolver for HTTP clients
12. `pkg/storage/sqlite.go` - SQLite query logging and statistics
13. `pkg/telemetry/telemetry.go` - OpenTelemetry and Prometheus metrics

**Estimated Time**: 2-3 hours

---

## Phase 2: Code Refactoring (MEDIUM-HIGH PRIORITY)

### 2.1 Refactor dns/server.go (1,333 lines → ~400 lines per file)

**Current Structure Problems**:
- Mixed concerns: server lifecycle, DNS handling, policy evaluation, response building
- 22 functions in single file
- Hard to navigate and maintain

**Refactoring Plan**:

#### Create `pkg/dns/handler.go` (~500 lines)
**Move from server.go**:
- `handleDNSQuery()` - Main query handler
- `handleRecursiveQuery()` - Recursive resolution
- `shouldBlockDomain()` - Blocking logic
- `isWhitelisted()` - Whitelist checking
- `isDNSSECQuery()` - DNSSEC detection
- Policy evaluation helpers

#### Create `pkg/dns/response.go` (~300 lines)
**Move from server.go**:
- `createBlockedResponse()` - Blocked domain responses
- `createLocalResponse()` - Local record responses
- `createSOAResponse()` - SOA record builder
- `copyQuestion()` - Question copying
- `setEDNS0()` - EDNS0 handling
- `addExtraRecords()` - Additional record handling

#### Keep in `pkg/dns/server.go` (~400 lines)
- `Server` struct definition
- `New()` constructor
- `Start()`, `Stop()`, `Shutdown()` - Lifecycle methods
- Server initialization and setup
- Configuration reloading
- Whitelist/blocklist manager integration

#### Create `pkg/dns/metrics.go` (~150 lines)
**Extract metrics logic**:
- All telemetry recording
- Prometheus metric updates
- Query type counting
- Response time tracking

**Files Affected**:
- `pkg/dns/server.go` (reduce to ~400 lines)
- Create: `pkg/dns/handler.go` (~500 lines)
- Create: `pkg/dns/response.go` (~300 lines)
- Create: `pkg/dns/metrics.go` (~150 lines)
- Update: `pkg/dns/server_test.go` (imports and structure)

**Testing Strategy**:
- Keep existing test coverage
- Ensure no functional changes
- Run full integration test suite
- Verify performance benchmarks unchanged

**Estimated Time**: 1.5-2 days

---

### 2.2 Refactor storage/sqlite.go (991 lines → ~500 + ~300 lines)

**Current Issues**:
- Query logging mixed with statistics
- Migration logic in main file
- Long file hard to navigate

**Refactoring Plan**:

#### Create `pkg/storage/queries.go` (~300 lines)
**Move query-related methods**:
- `LogQuery()`
- `GetRecentQueries()`
- `GetQueries()`
- `GetQueriesByDomain()`
- Query filtering helpers

#### Create `pkg/storage/stats.go` (~200 lines)
**Move statistics methods**:
- `GetStatistics()`
- `GetStatsSince()`
- `GetQueryTypeCounts()`
- `GetTopDomains()`
- Statistics aggregation helpers

#### Keep in `pkg/storage/sqlite.go` (~500 lines)
- `SQLiteStorage` struct
- `New()` constructor
- Database initialization
- Migration execution
- Connection management
- `Cleanup()` and maintenance

**Estimated Time**: 1 day

---

## Phase 3: Cleanup & Removal (MEDIUM PRIORITY)

### 3.1 Remove D1 Storage Stub

**Files to Remove**:
- `pkg/storage/d1_stub.go` (entire file)

**Files to Update**:
- `pkg/storage/storage.go` - Remove D1 reference from comments
- Update documentation to note D1 as future enhancement

**Estimated Time**: 30 minutes

---

### 3.2 Clean Up Unused Code

**Items to Address**:

1. **Remove unused msgPool** (`pkg/dns/server.go` lines 31-35)
   - Currently defined but never used
   - Remove sync.Pool variable
   - Remove from linter ignore list

2. **Remove unused prepared statements** (`pkg/storage/sqlite.go` lines 33-34)
   - `stmtGetRecentQueries` and `stmtGetStatistics` defined but unused
   - Either implement or remove
   - Remove from linter ignore list

3. **Update build-time version comment** (`cmd/glory-hole/main.go` line 42)
   - Change "0.7.2" reference to generic "version number"

**Estimated Time**: 1 hour

---

## Phase 4: Test Coverage Improvements (HIGH PRIORITY)

### 4.1 Improve API Package Coverage (58.4% → 75%+)

**Focus Areas**:
1. **Error Path Testing** - Handler error conditions
2. **Middleware Testing** - Auth, CORS, rate limiting edge cases
3. **UI Endpoints** - HTMX partial responses
4. **Configuration Updates** - Live config reload via API

**Files to Enhance**:
- `pkg/api/handlers_test.go` - Add error scenarios
- `pkg/api/middleware_test.go` - Complete middleware coverage
- `pkg/api/ui_handlers_test.go` - UI endpoint tests
- Create: `pkg/api/handlers_config_test.go` - Config update tests

**Estimated Time**: 2 days

---

### 4.2 Improve Storage Package Coverage (61.1% → 75%+)

**Focus Areas**:
1. **Error Handling** - Database errors, constraint violations
2. **Edge Cases** - Empty results, large datasets
3. **Migration Scenarios** - Upgrade paths, rollback
4. **Concurrent Access** - Multiple writers, read consistency

**Files to Enhance**:
- `pkg/storage/sqlite_test.go` - Add error path tests
- Create: `pkg/storage/migrations_test.go` - Migration testing
- Create: `pkg/storage/concurrent_test.go` - Concurrency tests

**Estimated Time**: 2 days

---

### 4.3 Improve Rate Limit Coverage (67.0% → 80%+)

**Focus Areas**:
1. **Token Bucket Edge Cases** - Refill timing, burst limits
2. **Concurrent Requests** - Thread safety verification
3. **IP Handling** - Trusted proxy scenarios, malformed IPs
4. **Cleanup** - Memory leak prevention

**Files to Enhance**:
- `pkg/ratelimit/ratelimit_test.go` - Add edge case tests

**Estimated Time**: 1 day

---

## Phase 5: Documentation Updates (LOW-MEDIUM PRIORITY)

### 5.1 Update Version References
- Update CHANGELOG.md with v0.9 improvements
- Update README badges if needed
- Ensure all example configs are current

### 5.2 Document Breaking Changes
- Whitelist manager API changes (if any external integrations)
- Removed D1 stub (note in release notes)
- File restructuring (for contributors)

**Estimated Time**: 2-3 hours

---

## Implementation Order

### Week 1 (Days 1-3)
1. **Day 1 Morning**: Whitelist performance fix (6-8 hours)
2. **Day 1 Afternoon**: Package documentation (2-3 hours)
3. **Day 2-3**: DNS server refactoring (1.5-2 days)

### Week 2 (Days 4-7)
4. **Day 4**: Storage refactoring (1 day)
5. **Day 5**: API test coverage improvements (2 days start)
6. **Day 6**: API test coverage completion + Storage tests start
7. **Day 7**: Storage and RateLimit test coverage completion

### Final Pass
8. **Cleanup**: Remove D1 stub, unused code (1.5 hours)
9. **Documentation**: Update changelog, version references (2-3 hours)
10. **Validation**: Run full test suite, benchmarks, integration tests

---

## Testing Strategy

### After Each Phase
1. Run unit tests: `make test`
2. Run integration tests: `go test ./test/...`
3. Run benchmarks: `go test -bench=. ./test/load/...`
4. Check coverage: `make test-coverage`
5. Run linter: `make lint`

### Before Release
1. Full CI pipeline pass
2. Load test comparison (pre vs post refactor)
3. Memory profiling (no regressions)
4. Manual QA of critical paths

---

## Success Criteria

### Performance
- [ ] Whitelist lookups are lock-free (atomic)
- [ ] No performance regression in benchmarks
- [ ] Memory usage stable or improved

### Code Quality
- [ ] No files exceed 600 lines
- [ ] All packages have godoc comments
- [ ] No unused code remains
- [ ] Linter passes with zero exclusions (or minimal justified ones)

### Test Coverage
- [ ] Overall coverage ≥ 85%
- [ ] API package ≥ 75%
- [ ] Storage package ≥ 75%
- [ ] RateLimit package ≥ 80%

### Documentation
- [ ] CHANGELOG updated with v0.9 changes
- [ ] README reflects current state
- [ ] Migration guide for breaking changes (if any)

---

## Risk Mitigation

### High-Risk Changes
1. **DNS server refactoring** - Core functionality
   - Mitigation: Keep existing tests, no behavior changes, incremental refactor
   - Validation: Full integration test suite must pass

2. **Whitelist manager rewrite** - Performance critical
   - Mitigation: Benchmark before/after, feature flag for rollback
   - Validation: Load tests show improvement, no correctness issues

### Rollback Plan
- Keep commits atomic and well-documented
- Tag pre-refactor state as `v0.9-pre-refactor`
- Maintain separate feature branches for major changes
- Each phase can be reverted independently

---

## Notes

- All changes maintain backward compatibility where possible
- Focus on internal improvements, minimal API surface changes
- Prioritize stability and performance over new features
- Keep refactoring separate from feature additions
