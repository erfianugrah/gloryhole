# Glory-Hole DNS Server Configuration

# Server settings
server:
  listen_address: ":53"
  tcp_enabled: true
  udp_enabled: true
  web_ui_address: ":8080"

# Upstream DNS servers
upstream_dns_servers:
  - "1.1.1.1:53"
  - "8.8.8.8:53"

# Update settings
update_interval: "24h"
auto_update_blocklists: true

# Blocklists
blocklists:
  - "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"

# Whitelist
whitelist:
  - "example-allowed-domain.com"

# Local DNS overrides
overrides:
  nas.local: "192.168.1.100"
  router.local: "192.168.1.1"

# CNAME overrides
cname_overrides:
  storage.local: "nas.local."

# Local DNS Records (Advanced)
# This section provides more control than simple overrides
# Features: Multiple IPs, AAAA records, wildcards, custom TTLs
local_records:
  enabled: true
  records:
    # A record with single IPv4 address
    - domain: "nas.local"
      type: "A"
      ips:
        - "192.168.1.100"
      ttl: 300  # optional, defaults to 300

    # A record with multiple IPs (round-robin)
    - domain: "server.local"
      type: "A"
      ips:
        - "192.168.1.10"
        - "192.168.1.11"
        - "192.168.1.12"

    # AAAA record for IPv6
    - domain: "server.local"
      type: "AAAA"
      ips:
        - "fe80::1"
        - "fe80::2"

    # CNAME record
    - domain: "storage.local"
      type: "CNAME"
      target: "nas.local"

    # Wildcard record (matches *.dev.local)
    # Note: Only matches one level (server.dev.local, NOT sub.server.dev.local)
    - domain: "*.dev.local"
      type: "A"
      wildcard: true
      ips:
        - "192.168.1.200"

# Database (Query Logging & Statistics)
database:
  enabled: true
  backend: "sqlite"              # sqlite or d1 (cloudflare)

  # SQLite configuration
  sqlite:
    path: "./glory-hole.db"
    busy_timeout: 5000           # milliseconds
    wal_mode: true               # write-ahead logging for better concurrency
    cache_size: 10000            # KB

  # D1 configuration (Cloudflare edge database)
  d1:
    account_id: ""               # Cloudflare account ID
    database_id: ""              # D1 database ID
    api_token: ""                # Cloudflare API token with D1 access

  # Buffer settings (async writes for performance)
  buffer_size: 1000              # queries to buffer before flush
  flush_interval: "5s"           # how often to flush buffer
  batch_size: 100                # max queries per batch insert

  # Retention policy
  retention_days: 7              # days to keep detailed logs

  # Statistics aggregation
  statistics:
    enabled: true
    aggregation_interval: "1h"   # hourly rollups

# Cache
cache:
  enabled: true
  max_entries: 10000
  min_ttl: "60s"
  max_ttl: "24h"
  negative_ttl: "5m"

# Logging
logging:
  level: "info"          # debug, info, warn, error
  format: "text"         # json, text
  output: "stdout"       # stdout, stderr, file
  add_source: true       # include file:line in logs (great for debugging, adds ~1-2Î¼s overhead per log)
  file_path: ""          # required if output=file
  max_size: 100          # MB
  max_backups: 3
  max_age: 7             # days

# Policy Engine (Advanced Rule-Based Filtering)
policy:
  enabled: true
  rules:
    # Block social media during work hours (9 AM - 5 PM)
    - name: "Block social media during work hours"
      logic: 'Hour >= 9 && Hour < 17 && (DomainMatches(Domain, "facebook") || DomainMatches(Domain, "twitter") || DomainMatches(Domain, "instagram"))'
      action: "block"
      enabled: true

    # Allow specific internal network ranges
    - name: "Allow internal network"
      logic: 'IPInCIDR(ClientIP, "192.168.1.0/24") || IPInCIDR(ClientIP, "10.0.0.0/8")'
      action: "allow"
      enabled: true

    # Block gambling sites
    - name: "Block gambling"
      logic: 'DomainMatches(Domain, "casino") || DomainMatches(Domain, "poker") || DomainMatches(Domain, "betting")'
      action: "block"
      enabled: true

    # Block after hours (outside 6 AM - 11 PM)
    - name: "Block after hours"
      logic: 'Hour < 6 || Hour >= 23'
      action: "block"
      enabled: false  # disabled by default

# Telemetry (OpenTelemetry)
telemetry:
  enabled: true
  service_name: "glory-hole"
  service_version: "dev"
  prometheus_enabled: true
  prometheus_port: 9090
  tracing_enabled: false
  tracing_endpoint: ""
