{{template "base.html" .}}

{{define "title"}}Clients - Gloryhole{{end}}

{{define "content"}}
<div class="clients-page">
    <div class="page-header">
        <div>
            <h2>Clients</h2>
            <p class="section-description">Per-client activity derived from query logs. Edit names or assign groups to organize devices.</p>
        </div>
        <form id="clients-filter-form" class="clients-actions" autocomplete="off">
            <input type="text" id="client-search" name="search" class="filter-input" placeholder="Search by name, IP, or group">
            <div class="is-visually-hidden">
                <input type="hidden" name="limit" id="clients-limit" value="{{.Limit}}">
                <input type="hidden" name="offset" id="clients-offset" value="{{.Offset}}">
            </div>
            <button class="btn btn-primary" type="button" data-open-group-modal>Manage Groups</button>
        </form>
    </div>

    <div class="clients-table-wrapper">
        <div id="clients-table-container"
             data-clients-limit="{{.Limit}}"
             data-clients-offset="{{.Offset}}"
             data-clients-has-more="{{if eq (len .Clients) .Limit}}true{{else}}false{{end}}"
             hx-get="/api/ui/clients"
             hx-trigger="load, refresh, filters-changed, every 30s"
             hx-swap="morph"
             hx-ext="idiomorph"
             hx-indicator="#clients-loading"
             hx-include="#clients-filter-form">
            {{template "clients_partial.html" .}}
        </div>
    </div>
    <div id="clients-loading" class="hx-indicator">Refreshingâ€¦</div>

    <div class="pagination">
        <button class="btn btn-secondary" type="button" data-clients-page-shift="-1">Previous</button>
        <span style="margin: 0 1rem;">Page <span id="clients-current-page">{{.Page}}</span></span>
        <button class="btn btn-secondary" type="button" data-clients-page-shift="1">Next</button>
    </div>
</div>

<!-- Client Modal -->
<div id="client-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="client-modal-title" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="client-modal-title">Edit Client</h3>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <form id="client-form">
            <input type="hidden" id="client-ip">
            <div class="form-group">
                <label for="client-name">Display Name</label>
                <input type="text" id="client-name" placeholder="Friendly name (e.g., Living Room Apple TV)">
            </div>
            <div class="form-group">
                <label for="client-group">Group</label>
                <select id="client-group"></select>
            </div>
            <div class="form-group">
                <label for="client-notes">Notes</label>
                <textarea id="client-notes" rows="3" placeholder="Optional notes"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
                <button type="submit" class="btn btn-primary">Save Client</button>
            </div>
        </form>
    </div>
</div>

<!-- Group Modal -->
<div id="group-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="group-modal-title" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="group-modal-title">Client Groups</h3>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="group-list" id="group-list"></div>
        <form id="group-form" class="group-form">
            <input type="hidden" id="group-original-name">
            <div class="form-group">
                <label for="group-name">Group Name</label>
                <input type="text" id="group-name" required placeholder="e.g., Kids, Guests">
            </div>
            <div class="form-group">
                <label for="group-color">Color</label>
                <input type="color" id="group-color" value="#3b82f6">
            </div>
            <div class="form-group">
                <label for="group-description">Description</label>
                <textarea id="group-description" rows="2" placeholder="Optional description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" data-reset-group>Reset</button>
                <button type="submit" class="btn btn-primary">Save Group</button>
            </div>
        </form>
    </div>
</div>

<template id="group-row-template">
    <div class="group-row">
        <div class="group-meta">
            <span class="group-chip"></span>
            <div class="group-text">
                <div class="group-name"></div>
                <div class="group-description"></div>
            </div>
        </div>
        <div class="group-actions">
            <button class="btn btn-secondary btn-sm" data-edit-group>Edit</button>
            <button class="btn btn-danger btn-sm" data-delete-group>Delete</button>
        </div>
    </div>
</template>

<script>
(function() {
    const clientsContainer = document.getElementById('clients-table-container');
    const searchInput = document.getElementById('client-search');
    const limitInput = document.getElementById('clients-limit');
    const offsetInput = document.getElementById('clients-offset');
    const pageLabel = document.getElementById('clients-current-page');
    const paginationButtons = document.querySelectorAll('[data-clients-page-shift]');
    const modal = document.getElementById('client-modal');
    const groupModal = document.getElementById('group-modal');
    const groupList = document.getElementById('group-list');
    const groupTemplate = document.getElementById('group-row-template');
    const clientGroupSelect = document.getElementById('client-group');
    const hx = window.htmx;
    let searchTimer = null;
    let paginationMeta = {
        limit: Number(limitInput?.value) || 1,
        offset: Number(offsetInput?.value) || 0,
        has_more: clientsContainer?.dataset.clientsHasMore !== 'false'
    };

    function closeModal(target) {
        if (target) {
            target.style.display = 'none';
        }
    }

    function openModal(target) {
        if (target) {
            target.style.display = 'flex';
        }
    }

    function fetchJSON(url, options) {
        return fetch(url, options).then(async (res) => {
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || res.statusText);
            }
            if (res.status === 204) {
                return {};
            }
            return res.json();
        });
    }

    function triggerClientsRefresh(eventName) {
        if (clientsContainer && hx) {
            hx.trigger(clientsContainer, eventName || 'refresh');
        }
    }

    function updatePaginationControls(meta) {
        if (!meta) {
            meta = paginationMeta;
        }
        const limit = Number(meta.limit ?? paginationMeta.limit ?? 1);
        const offset = Number(meta.offset ?? paginationMeta.offset ?? 0);
        const hasMore = meta.has_more !== undefined ? meta.has_more : paginationMeta.has_more;
        paginationMeta = { limit, offset, has_more: hasMore };
        if (pageLabel) {
            pageLabel.textContent = Math.floor(offset / limit) + 1;
        }
        const prevBtn = document.querySelector('[data-clients-page-shift="-1"]');
        const nextBtn = document.querySelector('[data-clients-page-shift="1"]');
        if (prevBtn) {
            prevBtn.disabled = offset === 0;
        }
        if (nextBtn) {
            nextBtn.disabled = hasMore === false;
        }
        if (clientsContainer) {
            clientsContainer.dataset.clientsLimit = String(limit);
            clientsContainer.dataset.clientsOffset = String(offset);
            clientsContainer.dataset.clientsHasMore = hasMore === false ? 'false' : 'true';
        }
    }

    function refreshGroups() {
        fetchJSON('/api/client-groups')
            .then((data) => {
                const groups = data.groups || [];
                groupList.innerHTML = '';
                clientGroupSelect.innerHTML = '<option value="">Unassigned</option>';
                groups.forEach((group) => {
                    const option = document.createElement('option');
                    option.value = group.name;
                    option.textContent = group.name;
                    clientGroupSelect.appendChild(option);

                    const clone = groupTemplate.content.cloneNode(true);
                    const chip = clone.querySelector('.group-chip');
                    chip.textContent = group.name;
                    chip.style.setProperty('--chip-color', group.color || '#3b82f6');
                    clone.querySelector('.group-name').textContent = group.name;
                    clone.querySelector('.group-description').textContent = group.description || 'No description';
                    clone.querySelector('[data-edit-group]').dataset.group = group.name;
                    clone.querySelector('[data-delete-group]').dataset.group = group.name;
                    clone.querySelector('[data-delete-group]').dataset.color = group.color || '#3b82f6';
                    clone.querySelector('[data-delete-group]').dataset.description = group.description || '';
                    clone.querySelector('[data-edit-group]').dataset.color = group.color || '#3b82f6';
                    clone.querySelector('[data-edit-group]').dataset.description = group.description || '';
                    groupList.appendChild(clone);
                });
            })
            .catch((err) => console.error('Failed to load groups', err));
    }

    function openClientModal(row) {
        const ip = row.dataset.client;
        const name = row.dataset.name;
        const notes = row.dataset.notes || '';
        const group = row.dataset.group || '';

        document.getElementById('client-ip').value = ip;
        document.getElementById('client-name').value = name === ip ? '' : name;
        document.getElementById('client-notes').value = notes;
        clientGroupSelect.value = group;

        openModal(modal);
    }

    document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
            return;
        }
        const trigger = target.closest('[data-edit-client]');
        if (trigger) {
            const row = trigger.closest('[data-client-row]');
            if (row) {
                openClientModal(row);
            }
        }
    });

    document.querySelectorAll('[data-close-modal]').forEach((btn) => {
        btn.addEventListener('click', () => {
            closeModal(btn.closest('.modal'));
        });
    });

    document.querySelector('[data-open-group-modal]')?.addEventListener('click', () => {
        openModal(groupModal);
        refreshGroups();
    });

    document.getElementById('client-form')?.addEventListener('submit', (event) => {
        event.preventDefault();
        const ip = document.getElementById('client-ip').value;
        const payload = {
            display_name: document.getElementById('client-name').value,
            group_name: clientGroupSelect.value,
            notes: document.getElementById('client-notes').value,
        };
        fetchJSON(`/api/clients/${encodeURIComponent(ip)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        })
            .then(() => {
                closeModal(modal);
                triggerClientsRefresh('refresh');
            })
            .catch((err) => alert(err.message || 'Failed to update client'));
    });

    groupList?.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const name = target.dataset.group;
        if (target.dataset.editGroup) {
            document.getElementById('group-original-name').value = name;
            document.getElementById('group-name').value = name || '';
            document.getElementById('group-description').value = target.dataset.description || '';
            document.getElementById('group-color').value = target.dataset.color || '#3b82f6';
        }
        if (target.dataset.deleteGroup && name) {
            if (confirm(`Delete group "${name}"? Clients will be unassigned.`)) {
                fetchJSON(`/api/client-groups/${encodeURIComponent(name)}`, { method: 'DELETE' })
                    .then(() => {
                        refreshGroups();
                        triggerClientsRefresh('refresh');
                    })
                    .catch((err) => alert(err.message || 'Failed to delete group'));
            }
        }
    });

    document.getElementById('group-form')?.addEventListener('submit', (event) => {
        event.preventDefault();
        const original = document.getElementById('group-original-name').value;
        const payload = {
            name: document.getElementById('group-name').value,
            description: document.getElementById('group-description').value,
            color: document.getElementById('group-color').value,
        };
        const url = original
            ? `/api/client-groups/${encodeURIComponent(original)}`
            : '/api/client-groups';
        const method = original ? 'PUT' : 'POST';
        fetchJSON(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        })
            .then(() => {
                document.getElementById('group-form').reset();
                document.getElementById('group-original-name').value = '';
                refreshGroups();
            })
            .catch((err) => alert(err.message || 'Failed to save group'));
    });

    document.querySelector('[data-reset-group]')?.addEventListener('click', () => {
        document.getElementById('group-form').reset();
        document.getElementById('group-original-name').value = '';
    });

    paginationButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const delta = Number(button.dataset.clientsPageShift) || 0;
            const limit = Number(limitInput?.value) || 1;
            const currentOffset = Number(offsetInput?.value) || 0;
            if (delta < 0 && currentOffset === 0) {
                return;
            }
            if (delta > 0 && paginationMeta.has_more === false) {
                return;
            }
            const nextOffset = Math.max(0, currentOffset + delta * limit);
            offsetInput.value = String(nextOffset);
            updatePaginationControls({ limit, offset: nextOffset, has_more: true });
            triggerClientsRefresh('refresh');
        });
    });

    function scheduleSearchRefresh() {
        if (!offsetInput) {
            return;
        }
        offsetInput.value = '0';
        if (searchTimer) {
            window.clearTimeout(searchTimer);
        }
        searchTimer = window.setTimeout(() => triggerClientsRefresh('filters-changed'), 275);
    }

    searchInput?.addEventListener('input', scheduleSearchRefresh);

    document.addEventListener('clients-page-meta', (event) => {
        const meta = event.detail || {};
        if (typeof meta.limit === 'number') {
            limitInput.value = String(meta.limit);
        }
        if (typeof meta.offset === 'number') {
            offsetInput.value = String(meta.offset);
        }
        const hasMore = typeof meta.has_more === 'boolean'
            ? meta.has_more
            : (typeof meta.count === 'number' && typeof meta.limit === 'number' ? meta.count >= meta.limit : true);
        updatePaginationControls({
            limit: Number(limitInput.value) || paginationMeta.limit,
            offset: Number(offsetInput.value) || 0,
            has_more: hasMore,
        });
    });

    updatePaginationControls();
    refreshGroups();
})();
</script>
{{end}}
