{{template "base.html" .}}

{{define "title"}}Clients - Gloryhole{{end}}

{{define "content"}}
<div class="clients-page">
    <div class="page-header">
        <div>
            <h2>Clients</h2>
            <p class="section-description">Per-client activity derived from query logs. Edit names or assign groups to organize devices.</p>
        </div>
        <form id="clients-filter-form" class="clients-actions" autocomplete="off">
            <input type="text" id="client-search" name="search" class="filter-input" placeholder="Search by name, IP, or group">
            <div class="is-visually-hidden">
                <input type="hidden" name="limit" id="clients-limit" value="{{.Limit}}">
                <input type="hidden" name="offset" id="clients-offset" value="{{.Offset}}">
            </div>
            <button class="btn btn-primary" type="button" data-open-group-modal>Manage Groups</button>
        </form>
    </div>

    <div class="clients-table-wrapper">
        <div id="clients-table-container"
             data-clients-limit="{{.Limit}}"
             data-clients-offset="{{.Offset}}"
             data-clients-has-more="{{if eq (len .Clients) .Limit}}true{{else}}false{{end}}"
             hx-get="/api/ui/clients"
             hx-trigger="load, refresh, filters-changed, every 30s"
             hx-swap="morph"
             hx-ext="idiomorph"
             hx-indicator="#clients-loading"
             hx-include="#clients-filter-form">
            {{template "clients_partial.html" .}}
        </div>
    </div>
    <div id="clients-loading" class="hx-indicator">Refreshingâ€¦</div>

    <div class="pagination">
        <button class="btn btn-secondary" type="button" data-clients-page-shift="-1">Previous</button>
        <span style="margin: 0 1rem;">Page <span id="clients-current-page">{{.Page}}</span></span>
        <button class="btn btn-secondary" type="button" data-clients-page-shift="1">Next</button>
    </div>
</div>

<!-- Client Modal -->
<div id="client-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="client-modal-title" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="client-modal-title">Edit Client</h3>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <form id="client-form">
            <input type="hidden" id="client-ip">
            <div class="form-group">
                <label for="client-name">Display Name</label>
                <input type="text" id="client-name" placeholder="Friendly name (e.g., Living Room Apple TV)">
            </div>
            <div class="form-group">
                <label for="client-group">Group</label>
                <select id="client-group"></select>
            </div>
            <div class="form-group">
                <label for="client-notes">Notes</label>
                <textarea id="client-notes" rows="3" placeholder="Optional notes"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" data-close-modal>Cancel</button>
                <button type="submit" class="btn btn-primary">Save Client</button>
            </div>
        </form>
    </div>
</div>

<!-- Group Modal -->
<div id="group-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="group-modal-title" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="group-modal-title">Client Groups</h3>
            <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div class="group-list" id="group-list"></div>
        <form id="group-form" class="group-form">
            <input type="hidden" id="group-original-name">
            <div class="form-group">
                <label for="group-name">Group Name</label>
                <input type="text" id="group-name" required placeholder="e.g., Kids, Guests">
            </div>
            <div class="form-group">
                <label for="group-color">Color</label>
                <input type="color" id="group-color" value="#3b82f6">
            </div>
            <div class="form-group">
                <label for="group-description">Description</label>
                <textarea id="group-description" rows="2" placeholder="Optional description"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" data-reset-group>Reset</button>
                <button type="submit" class="btn btn-primary">Save Group</button>
            </div>
        </form>
    </div>
</div>

<template id="group-row-template">
    <div class="group-row">
        <div class="group-meta">
            <span class="group-chip"></span>
            <div class="group-text">
                <div class="group-name"></div>
                <div class="group-description"></div>
            </div>
        </div>
        <div class="group-actions">
            <button class="btn btn-secondary btn-sm" data-edit-group>Edit</button>
            <button class="btn btn-danger btn-sm" data-delete-group>Delete</button>
        </div>
    </div>
</template>

<script type="module" src="/static/js/clients-init.js"></script>
{{end}}
