<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}Glory-Hole DNS{{end}}</title>
    <script>
    (function() {
        const STORAGE_KEY = "gloryhole-theme";
        let theme = "light";
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored === "dark" || stored === "light") {
                theme = stored;
            } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                theme = "dark";
            }
        } catch (_) {}
        document.documentElement.dataset.theme = theme;
        document.documentElement.style.colorScheme = theme;
    })();
    </script>
    <script src="/static/js/mini-htmx.js" defer></script>
    <script src="/static/js/simple-chart.js" defer></script>
    <script src="/static/js/trace-modal.js" defer></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>üï≥Ô∏è Glory-Hole DNS</h1>
                <span class="version">{{.Version}}</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/queries" class="nav-link">Queries</a>
                <a href="/policies" class="nav-link">Policies</a>
                <a href="/clients" class="nav-link">Clients</a>
                <a href="/blocklists" class="nav-link">Blocklists</a>
                <a href="/settings" class="nav-link">Settings</a>
                <button type="button" class="theme-toggle" data-theme-toggle aria-pressed="false" title="Toggle theme">
                    <span class="icon-light" aria-hidden="true">‚òÄÔ∏è</span>
                    <span class="icon-dark" aria-hidden="true">üåô</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="container">
        {{block "content" .}}{{end}}
    </main>

    <footer class="footer">
        <div class="container">
            <p>Glory-Hole DNS Server - High-Performance Ad Blocking</p>
        </div>
    </footer>

    <div id="trace-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trace-modal-title" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="trace-modal-title">Decision Trace</h3>
                <button class="modal-close" data-trace-close>&times;</button>
            </div>
            <div id="trace-body" class="trace-body">
                <p class="text-muted">No trace data available.</p>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top:1rem;">
                <button class="btn btn-secondary" type="button" data-trace-close>Close</button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const STORAGE_KEY = "gloryhole-theme";
        const toggle = document.querySelector("[data-theme-toggle]");
        const media = window.matchMedia("(prefers-color-scheme: dark)");

        const safeStorage = {
            get() {
                try {
                    return localStorage.getItem(STORAGE_KEY);
                } catch (_) {
                    return null;
                }
            },
            set(value) {
                try {
                    localStorage.setItem(STORAGE_KEY, value);
                } catch (_) {
                    /* ignore */
                }
            },
            clear() {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                } catch (_) {
                    /* ignore */
                }
            }
        };

        function applyTheme(theme, emit) {
            const next = theme === "dark" ? "dark" : "light";
            document.documentElement.dataset.theme = next;
            document.documentElement.style.colorScheme = next;
            if (toggle) {
                toggle.setAttribute("aria-pressed", next === "dark" ? "true" : "false");
            }
            if (emit) {
                window.dispatchEvent(new CustomEvent("gh-theme-change", { detail: { theme: next }}));
            }
        }

        const stored = safeStorage.get();
        const initial = stored || (media.matches ? "dark" : "light");
        applyTheme(initial, false);

        if (toggle) {
            toggle.addEventListener("click", function() {
                const current = document.documentElement.dataset.theme === "dark" ? "dark" : "light";
                const next = current === "dark" ? "light" : "dark";
                applyTheme(next, true);
                safeStorage.set(next);
            });
        }

        function handleMedia(event) {
            if (safeStorage.get()) {
                return;
            }
            applyTheme(event.matches ? "dark" : "light", true);
        }

        if (typeof media.addEventListener === "function") {
            media.addEventListener("change", handleMedia);
        } else if (typeof media.addListener === "function") {
            media.addListener(handleMedia);
        }
    })();
    </script>
</body>
</html>
