<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}Gloryhole{{end}}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2395ea81'/><circle cx='50' cy='50' r='30' fill='%23141414'/><circle cx='50' cy='50' r='20' fill='none' stroke='%2395ea81' stroke-width='4'/></svg>">
    <script>
    (function() {
        const STORAGE_KEY = "gloryhole-theme";
        let theme = "light";
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored === "dark" || stored === "light") {
                theme = stored;
            } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                theme = "dark";
            }
        } catch (_) {}
        document.documentElement.dataset.theme = theme;
        document.documentElement.style.colorScheme = theme;
    })();
    </script>
    <script src="/static/js/vendor/htmx.min.js" defer></script>
    <script src="/static/js/vendor/idiomorph-ext.min.js" defer></script>
    <script src="/static/js/vendor/chart.umd.min.js" defer></script>
    <script src="/static/js/sidebar.js" defer></script>
    <script src="/static/js/focus-trap.js" defer></script>
    <script src="/static/js/form-validation.js" defer></script>
    <script src="/static/js/trace-modal.js" defer></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="app-shell {{block "body_class" .}}{{end}}">
    <!-- Top Header -->
    <header class="header">
        <button class="sidebar-toggle" type="button" aria-label="Toggle sidebar" aria-expanded="false" data-sidebar-toggle>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 7h16M4 12h16M4 17h16"></path>
            </svg>
        </button>
        <div class="header-brand">
            <svg class="header-brand-icon" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="9" fill="currentColor" opacity="0.12"></circle>
                <circle cx="12" cy="12" r="5.5" fill="none" stroke="currentColor" stroke-width="2"></circle>
            </svg>
            <h1>Gloryhole</h1>
        </div>
        <div class="header-actions">
            <button type="button" class="theme-toggle" data-theme-toggle aria-pressed="false" title="Toggle theme">
                <svg class="icon-light" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="4"></circle>
                    <path d="M12 3v2.5M12 18.5V21M4.22 4.22l1.77 1.77M17.99 17.99l1.78 1.78M3 12h2.5M18.5 12H21M4.22 19.78l1.77-1.77M17.99 6.01l1.78-1.78"></path>
                </svg>
                <svg class="icon-dark" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.75a9 9 0 1 1-9.75-9.74 7 7 0 0 0 9.75 9.74z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar" data-sidebar>
        <div class="sidebar-header">
            <span class="sidebar-tagline">send your unwanted queries to the gloryhole</span>
        </div>
        <nav class="sidebar-nav">
            <a href="/" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="/queries" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <span>Queries</span>
            </a>
            <a href="/clients" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span>Clients</span>
            </a>
            <a href="/policies" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <span>Policies</span>
            </a>
            <a href="/blocklists" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                </svg>
                <span>Blocklists</span>
            </a>
            <a href="/whitelist" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>Whitelist</span>
            </a>
            <a href="/localrecords" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
                <span>Local Records</span>
            </a>
            <a href="/conditionalforwarding" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="17 11 12 6 7 11"></polyline>
                    <polyline points="17 18 12 13 7 18"></polyline>
                </svg>
                <span>Conditional Forwarding</span>
            </a>
            <a href="/settings" class="sidebar-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
                </svg>
                <span>Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <form method="post" action="/logout" class="sidebar-logout-form">
                <button type="submit" class="sidebar-logout-button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" data-sidebar-overlay></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            {{block "content" .}}{{end}}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>Gloryhole - High-Performance DNS Server & Ad Blocker</p>
        </div>
    </footer>

    <div id="trace-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trace-modal-title" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="trace-modal-title">Decision Trace</h3>
                <button class="modal-close" data-trace-close>&times;</button>
            </div>
            <div id="trace-body" class="trace-body">
                <p class="text-muted">No trace data available.</p>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top:1rem;">
                <button class="btn btn-secondary" type="button" data-trace-close>Close</button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const STORAGE_KEY = "gloryhole-theme";
        const toggle = document.querySelector("[data-theme-toggle]");
        const media = window.matchMedia("(prefers-color-scheme: dark)");

        const safeStorage = {
            get() {
                try {
                    return localStorage.getItem(STORAGE_KEY);
                } catch (_) {
                    return null;
                }
            },
            set(value) {
                try {
                    localStorage.setItem(STORAGE_KEY, value);
                } catch (_) {
                    /* ignore */
                }
            },
            clear() {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                } catch (_) {
                    /* ignore */
                }
            }
        };

        function applyTheme(theme, emit) {
            const next = theme === "dark" ? "dark" : "light";
            document.documentElement.dataset.theme = next;
            document.documentElement.style.colorScheme = next;
            if (toggle) {
                toggle.setAttribute("aria-pressed", next === "dark" ? "true" : "false");
            }
            if (emit) {
                window.dispatchEvent(new CustomEvent("gh-theme-change", { detail: { theme: next }}));
            }
        }

        const stored = safeStorage.get();
        const initial = stored || (media.matches ? "dark" : "light");
        applyTheme(initial, false);

        if (toggle) {
            toggle.addEventListener("click", function() {
                const current = document.documentElement.dataset.theme === "dark" ? "dark" : "light";
                const next = current === "dark" ? "light" : "dark";
                applyTheme(next, true);
                safeStorage.set(next);
            });
        }

        function handleMedia(event) {
            if (safeStorage.get()) {
                return;
            }
            applyTheme(event.matches ? "dark" : "light", true);
        }

        if (typeof media.addEventListener === "function") {
            media.addEventListener("change", handleMedia);
        } else if (typeof media.addListener === "function") {
            media.addListener(handleMedia);
        }
    })();
    </script>
    <script>
    (function() {
        const toggle = document.querySelector('[data-nav-toggle]');
        const links = document.querySelector('[data-nav-links]');
        if (!toggle || !links) {
            return;
        }

        function closeMenu() {
            links.classList.remove('is-open');
            toggle.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
        }

        function openMenu() {
            links.classList.add('is-open');
            toggle.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
        }

        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = links.classList.contains('is-open');
            if (isOpen) {
                closeMenu();
            } else {
                openMenu();
            }
        });

        // Close menu when clicking backdrop
        links.addEventListener('click', function(e) {
            if (e.target === links && window.innerWidth < 768) {
                closeMenu();
            }
        });

        // Close menu after navigation
        document.addEventListener('htmx:afterSwap', function() {
            if (window.innerWidth < 768 && links.classList.contains('is-open')) {
                closeMenu();
            }
        });

        // Close menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && links.classList.contains('is-open')) {
                closeMenu();
                toggle.focus();
            }
        });
    })();
    </script>
</body>
</html>
