<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}Gloryhole{{end}}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2395ea81'/><circle cx='50' cy='50' r='30' fill='%23141414'/><circle cx='50' cy='50' r='20' fill='none' stroke='%2395ea81' stroke-width='4'/></svg>">
    <script>
    (function() {
        const STORAGE_KEY = "gloryhole-theme";
        let theme = "light";
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored === "dark" || stored === "light") {
                theme = stored;
            } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                theme = "dark";
            }
        } catch (_) {}
        document.documentElement.dataset.theme = theme;
        document.documentElement.style.colorScheme = theme;
    })();
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js" defer></script>
    <script src="https://unpkg.com/idiomorph/dist/idiomorph.min.js" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/idiomorph.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js" defer></script>
    <script src="/static/js/focus-trap.js" defer></script>
    <script src="/static/js/form-validation.js" defer></script>
    <script src="/static/js/trace-modal.js" defer></script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="app-shell {{block "body_class" .}}{{end}}">
    <nav class="navbar">
        <div class="container-fluid">
            <div class="nav-brand">
                <svg class="nav-brand-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="12" r="9" fill="currentColor" opacity="0.12"></circle>
                    <circle cx="12" cy="12" r="5.5" fill="none" stroke="currentColor" stroke-width="2"></circle>
                </svg>
                <div>
                    <h1>Gloryhole</h1>
                    <span class="version">send your unwanted queries to the gloryhole</span>
                </div>
            </div>
            <button class="nav-toggle" type="button" aria-label="Toggle navigation" aria-expanded="false" data-nav-toggle>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 7h16M4 12h16M4 17h16"></path>
                </svg>
            </button>
            <div class="nav-links" id="site-nav" data-nav-links>
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/queries" class="nav-link">Queries</a>
                <a href="/policies" class="nav-link">Policies</a>
                <a href="/whitelist" class="nav-link">Whitelist</a>
                <a href="/localrecords" class="nav-link">Local Records</a>
                <a href="/conditionalforwarding" class="nav-link">Conditional Forwarding</a>
                <a href="/clients" class="nav-link">Clients</a>
                <a href="/blocklists" class="nav-link">Blocklists</a>
                <a href="/settings" class="nav-link">Settings</a>
                <form method="post" action="/logout" class="nav-logout-form">
                    <button type="submit" class="nav-link nav-link-button">Logout</button>
                </form>
                <button type="button" class="theme-toggle" data-theme-toggle aria-pressed="false" title="Toggle theme">
                    <svg class="icon-light" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 3v2.5M12 18.5V21M4.22 4.22l1.77 1.77M17.99 17.99l1.78 1.78M3 12h2.5M18.5 12H21M4.22 19.78l1.77-1.77M17.99 6.01l1.78-1.78"></path>
                    </svg>
                    <svg class="icon-dark" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.75a9 9 0 1 1-9.75-9.74 7 7 0 0 0 9.75 9.74z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="container">
        {{block "content" .}}{{end}}
    </main>

    <footer class="footer">
        <div class="container">
            <p>Gloryhole - High-Performance DNS Server & Ad Blocker</p>
        </div>
    </footer>

    <div id="trace-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trace-modal-title" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="trace-modal-title">Decision Trace</h3>
                <button class="modal-close" data-trace-close>&times;</button>
            </div>
            <div id="trace-body" class="trace-body">
                <p class="text-muted">No trace data available.</p>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top:1rem;">
                <button class="btn btn-secondary" type="button" data-trace-close>Close</button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const STORAGE_KEY = "gloryhole-theme";
        const toggle = document.querySelector("[data-theme-toggle]");
        const media = window.matchMedia("(prefers-color-scheme: dark)");

        const safeStorage = {
            get() {
                try {
                    return localStorage.getItem(STORAGE_KEY);
                } catch (_) {
                    return null;
                }
            },
            set(value) {
                try {
                    localStorage.setItem(STORAGE_KEY, value);
                } catch (_) {
                    /* ignore */
                }
            },
            clear() {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                } catch (_) {
                    /* ignore */
                }
            }
        };

        function applyTheme(theme, emit) {
            const next = theme === "dark" ? "dark" : "light";
            document.documentElement.dataset.theme = next;
            document.documentElement.style.colorScheme = next;
            if (toggle) {
                toggle.setAttribute("aria-pressed", next === "dark" ? "true" : "false");
            }
            if (emit) {
                window.dispatchEvent(new CustomEvent("gh-theme-change", { detail: { theme: next }}));
            }
        }

        const stored = safeStorage.get();
        const initial = stored || (media.matches ? "dark" : "light");
        applyTheme(initial, false);

        if (toggle) {
            toggle.addEventListener("click", function() {
                const current = document.documentElement.dataset.theme === "dark" ? "dark" : "light";
                const next = current === "dark" ? "light" : "dark";
                applyTheme(next, true);
                safeStorage.set(next);
            });
        }

        function handleMedia(event) {
            if (safeStorage.get()) {
                return;
            }
            applyTheme(event.matches ? "dark" : "light", true);
        }

        if (typeof media.addEventListener === "function") {
            media.addEventListener("change", handleMedia);
        } else if (typeof media.addListener === "function") {
            media.addListener(handleMedia);
        }
    })();
    </script>
    <script>
    (function() {
        const toggle = document.querySelector('[data-nav-toggle]');
        const links = document.querySelector('[data-nav-links]');
        if (!toggle || !links) {
            return;
        }

        function closeMenu() {
            links.classList.remove('is-open');
            toggle.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
        }

        function openMenu() {
            links.classList.add('is-open');
            toggle.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
        }

        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = links.classList.contains('is-open');
            if (isOpen) {
                closeMenu();
            } else {
                openMenu();
            }
        });

        // Close menu when clicking backdrop
        links.addEventListener('click', function(e) {
            if (e.target === links && window.innerWidth < 768) {
                closeMenu();
            }
        });

        // Close menu after navigation
        document.addEventListener('htmx:afterSwap', function() {
            if (window.innerWidth < 768 && links.classList.contains('is-open')) {
                closeMenu();
            }
        });

        // Close menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && links.classList.contains('is-open')) {
                closeMenu();
                toggle.focus();
            }
        });
    })();
    </script>
</body>
</html>
