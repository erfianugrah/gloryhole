{{template "base.html" .}}

{{define "title"}}Settings - Glory-Hole DNS{{end}}

{{define "content"}}
<div class="settings-page">
    <div class="page-header">
        <h2>Settings</h2>
    </div>

    <!-- DNS Settings -->
    <div class="settings-section">
        <h3>DNS Configuration</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>DNS Listen Address</h4>
                <p>UDP and TCP DNS server bind address</p>
            </div>
            <div class="setting-value">
                <code>:53</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Upstream DNS Servers</h4>
                <p>Servers used for forwarding queries</p>
            </div>
            <div class="setting-value">
                <code>1.1.1.1:53, 8.8.8.8:53</code>
            </div>
        </div>
    </div>

    <!-- Cache Settings -->
    <div class="settings-section">
        <h3>Cache Configuration</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Cache Size</h4>
                <p>Maximum number of cached entries</p>
            </div>
            <div class="setting-value">
                <code>10,000</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Minimum TTL</h4>
                <p>Minimum cache time for records</p>
            </div>
            <div class="setting-value">
                <code>1m</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Maximum TTL</h4>
                <p>Maximum cache time for records</p>
            </div>
            <div class="setting-value">
                <code>24h</code>
            </div>
        </div>
    </div>

    <!-- Blocklist Settings -->
    <div class="settings-section">
        <h3>Blocklist Configuration</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Auto-Update</h4>
                <p>Automatically update blocklists</p>
            </div>
            <div class="setting-value">
                <label class="toggle-switch">
                    <input type="checkbox" checked disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Update Interval</h4>
                <p>How often to refresh blocklists</p>
            </div>
            <div class="setting-value">
                <code>24h</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Blocklist Sources</h4>
                <p>Active blocklist URLs</p>
            </div>
            <div class="setting-value">
                <button class="btn btn-secondary btn-sm">View Sources</button>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Manual Reload</h4>
                <p>Force reload all blocklists now</p>
            </div>
            <div class="setting-value">
                <button class="btn btn-primary btn-sm" onclick="reloadBlocklists()">Reload Now</button>
            </div>
        </div>
    </div>

    <!-- Feature Controls (Kill-Switches) -->
    <div class="settings-section">
        <h3>Feature Controls</h3>
        <p class="section-description">Temporarily disable features for troubleshooting or maintenance.</p>

        <!-- Blocklist Control -->
        <div class="feature-control-group">
            <div class="feature-header">
                <h4>Ad-Blocking (Blocklist)</h4>
                <span id="blocklist-status" class="status-badge">Enabled</span>
            </div>
            <p class="help-text">Temporarily disable domain blocking for troubleshooting false positives.</p>

            <div class="control-buttons">
                <button class="btn btn-danger btn-sm" onclick="disableFeature('blocklist', 30)">30 seconds</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('blocklist', 300)">5 minutes</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('blocklist', 1800)">30 minutes</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('blocklist', 3600)">1 hour</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('blocklist', 0)">Indefinitely</button>
                <button class="btn btn-success btn-sm" onclick="enableFeature('blocklist')">Re-enable</button>
            </div>

            <div id="blocklist-countdown" class="countdown-timer" style="display: none;">
                Will auto-re-enable in: <span id="blocklist-time">--</span>
            </div>
        </div>

        <!-- Policies Control -->
        <div class="feature-control-group">
            <div class="feature-header">
                <h4>Policy Engine</h4>
                <span id="policies-status" class="status-badge">Enabled</span>
            </div>
            <p class="help-text">Temporarily disable all policy rules while keeping basic blocklist active.</p>

            <div class="control-buttons">
                <button class="btn btn-danger btn-sm" onclick="disableFeature('policies', 30)">30 seconds</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('policies', 300)">5 minutes</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('policies', 1800)">30 minutes</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('policies', 3600)">1 hour</button>
                <button class="btn btn-danger btn-sm" onclick="disableFeature('policies', 0)">Indefinitely</button>
                <button class="btn btn-success btn-sm" onclick="enableFeature('policies')">Re-enable</button>
            </div>

            <div id="policies-countdown" class="countdown-timer" style="display: none;">
                Will auto-re-enable in: <span id="policies-time">--</span>
            </div>
        </div>
    </div>

    <!-- Storage Settings -->
    <div class="settings-section">
        <h3>Storage Configuration</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Backend</h4>
                <p>Query log storage backend</p>
            </div>
            <div class="setting-value">
                <code>SQLite</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Buffer Size</h4>
                <p>Queries buffered before write</p>
            </div>
            <div class="setting-value">
                <code>1,000</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Retention Period</h4>
                <p>How long to keep query logs</p>
            </div>
            <div class="setting-value">
                <code>7 days</code>
            </div>
        </div>
    </div>

    <!-- API Settings -->
    <div class="settings-section">
        <h3>API Server</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Listen Address</h4>
                <p>HTTP API and Web UI address</p>
            </div>
            <div class="setting-value">
                <code>:8080</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>CORS Enabled</h4>
                <p>Allow cross-origin requests</p>
            </div>
            <div class="setting-value">
                <label class="toggle-switch">
                    <input type="checkbox" checked disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Telemetry Settings -->
    <div class="settings-section">
        <h3>Telemetry & Monitoring</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Prometheus Metrics</h4>
                <p>Enable Prometheus endpoint</p>
            </div>
            <div class="setting-value">
                <label class="toggle-switch">
                    <input type="checkbox" checked disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Metrics Port</h4>
                <p>Prometheus endpoint port</p>
            </div>
            <div class="setting-value">
                <code>:9090</code>
            </div>
        </div>
    </div>

    <!-- System Info -->
    <div class="settings-section">
        <h3>System Information</h3>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Version</h4>
                <p>Glory-Hole DNS version</p>
            </div>
            <div class="setting-value">
                <code>{{.Version}}</code>
            </div>
        </div>
        <div class="setting-row">
            <div class="setting-label">
                <h4>Configuration File</h4>
                <p>Active configuration file path</p>
            </div>
            <div class="setting-value">
                <code>config.yml</code>
            </div>
        </div>
    </div>

    <div class="settings-info">
        <p><strong>Note:</strong> Most settings require a server restart to take effect. Edit <code>config.yml</code> and restart the service.</p>
        <p>For runtime changes, use the Policies page to add filtering rules.</p>
    </div>
</div>

<script>
async function reloadBlocklists() {
    const button = event.target;
    button.disabled = true;
    button.textContent = 'Reloading...';

    try {
        const response = await fetch('/api/blocklist/reload', {
            method: 'POST'
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Blocklists reloaded successfully!\n${result.domains} domains loaded.`);
        } else {
            const error = await response.json();
            alert('Error: ' + (error.message || 'Failed to reload blocklists'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        button.disabled = false;
        button.textContent = 'Reload Now';
    }
}

// Kill-switch control functions
let blocklistCountdownInterval = null;
let policiesCountdownInterval = null;

async function disableFeature(feature, duration) {
    const featureName = feature === 'blocklist' ? 'Blocklist' : 'Policies';
    const durationText = duration === 0 ? 'indefinitely' : formatDuration(duration);

    if (!confirm(`Disable ${featureName} ${durationText}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/features/${feature}/disable`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ duration: duration })
        });

        if (response.ok) {
            const result = await response.json();
            updateFeatureStatus();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.message || `Failed to disable ${featureName}`));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function enableFeature(feature) {
    const featureName = feature === 'blocklist' ? 'Blocklist' : 'Policies';

    try {
        const response = await fetch(`/api/features/${feature}/enable`, {
            method: 'POST'
        });

        if (response.ok) {
            updateFeatureStatus();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.message || `Failed to enable ${featureName}`));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function updateFeatureStatus() {
    try {
        const response = await fetch('/api/features');
        if (!response.ok) return;

        const data = await response.json();

        // Update blocklist status
        const blocklistStatus = document.getElementById('blocklist-status');
        const blocklistCountdown = document.getElementById('blocklist-countdown');
        if (data.blocklist_temp_disabled) {
            blocklistStatus.textContent = 'Disabled';
            blocklistStatus.className = 'status-badge status-disabled';
            blocklistCountdown.style.display = 'block';
            if (blocklistCountdownInterval) clearInterval(blocklistCountdownInterval);
            startCountdown('blocklist', new Date(data.blocklist_disabled_until));
        } else {
            blocklistStatus.textContent = 'Enabled';
            blocklistStatus.className = 'status-badge status-enabled';
            blocklistCountdown.style.display = 'none';
            if (blocklistCountdownInterval) {
                clearInterval(blocklistCountdownInterval);
                blocklistCountdownInterval = null;
            }
        }

        // Update policies status
        const policiesStatus = document.getElementById('policies-status');
        const policiesCountdown = document.getElementById('policies-countdown');
        if (data.policies_temp_disabled) {
            policiesStatus.textContent = 'Disabled';
            policiesStatus.className = 'status-badge status-disabled';
            policiesCountdown.style.display = 'block';
            if (policiesCountdownInterval) clearInterval(policiesCountdownInterval);
            startCountdown('policies', new Date(data.policies_disabled_until));
        } else {
            policiesStatus.textContent = 'Enabled';
            policiesStatus.className = 'status-badge status-enabled';
            policiesCountdown.style.display = 'none';
            if (policiesCountdownInterval) {
                clearInterval(policiesCountdownInterval);
                policiesCountdownInterval = null;
            }
        }
    } catch (error) {
        console.error('Failed to update feature status:', error);
    }
}

function startCountdown(feature, until) {
    const timeElement = document.getElementById(`${feature}-time`);

    function update() {
        const now = new Date();
        const remaining = Math.max(0, Math.floor((until - now) / 1000));

        if (remaining === 0) {
            updateFeatureStatus();
            return;
        }

        timeElement.textContent = formatDuration(remaining);
    }

    update();
    if (feature === 'blocklist') {
        blocklistCountdownInterval = setInterval(update, 1000);
    } else {
        policiesCountdownInterval = setInterval(update, 1000);
    }
}

function formatDuration(seconds) {
    if (seconds === 0) return 'indefinitely';
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (minutes < 60) return secs > 0 ? `${minutes}m ${secs}s` : `${minutes}m`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
}

// Update status on page load and every 5 seconds
updateFeatureStatus();
setInterval(updateFeatureStatus, 5000);
</script>

<style>
.settings-info {
    background-color: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #92400e;
}

.settings-info p {
    margin: 0.5rem 0;
}

.settings-info code {
    background-color: #fef3c7;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', Courier, monospace;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

/* Feature Controls */
.section-description {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
}

.feature-control-group {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    background-color: var(--card-bg);
}

.feature-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.feature-header h4 {
    margin: 0;
    font-size: 1.1rem;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-enabled {
    background-color: #10b981;
    color: white;
}

.status-disabled {
    background-color: #ef4444;
    color: white;
}

.control-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-success {
    background-color: #10b981;
    color: white;
    border: none;
}

.btn-success:hover {
    background-color: #059669;
}

.countdown-timer {
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #fef3c7;
    border-left: 4px solid #f59e0b;
    border-radius: 0.25rem;
    font-weight: 500;
}

.countdown-timer span {
    font-family: 'Courier New', monospace;
    color: #92400e;
}
</style>
{{end}}
