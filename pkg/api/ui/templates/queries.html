{{template "base.html" .}}

{{define "title"}}Query Log - Glory-Hole DNS{{end}}

{{define "content"}}
<div class="queries-page">
    <div class="page-header">
        <h2>Query Log</h2>
        <form id="query-filter-form" class="filters" autocomplete="off">
            <input type="text" id="filter-domain" name="domain" placeholder="Filter by domain..." class="filter-input">
            <select id="filter-type" name="type" class="filter-select">
                <option value="">All Types</option>
                <option value="A">A</option>
                <option value="AAAA">AAAA</option>
                <option value="CNAME">CNAME</option>
                <option value="MX">MX</option>
                <option value="PTR">PTR</option>
                <option value="TXT">TXT</option>
            </select>
            <select id="filter-status" name="status" class="filter-select">
                <option value="">All Queries</option>
                <option value="blocked">Blocked Only</option>
                <option value="allowed">Allowed Only</option>
                <option value="cached">Cached Only</option>
            </select>
            <input type="datetime-local" id="filter-start" name="start" class="filter-input" placeholder="Start time">
            <input type="datetime-local" id="filter-end" name="end" class="filter-input" placeholder="End time">
            <button class="btn btn-secondary btn-sm" type="button" data-reset-filters>Reset</button>
            <div class="is-visually-hidden">
                <input type="hidden" name="limit" id="queries-limit" value="100">
                <input type="hidden" name="offset" id="queries-offset" value="0">
            </div>
        </form>
    </div>

    <div id="queries-container"
         hx-get="/api/ui/queries"
         hx-trigger="load, every 6s, filters-changed, refresh"
         hx-swap="morph"
         hx-ext="idiomorph"
         hx-indicator="#queries-loading"
         hx-include="#query-filter-form">
        <div class="loading">Loading queries...</div>
    </div>
    <div id="queries-loading" class="hx-indicator">Refreshingâ€¦</div>

    <div class="pagination">
        <button id="prev-btn" class="btn btn-secondary" type="button" data-page-shift="-1">Previous</button>
        <span id="page-info" style="margin: 0 1rem;">Page <span id="current-page">1</span></span>
        <button class="btn btn-secondary" type="button" data-page-shift="1">Next</button>
    </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('queries-container');
    const filterForm = document.getElementById('query-filter-form');
    const limitInput = document.getElementById('queries-limit');
    const offsetInput = document.getElementById('queries-offset');
    const pageLabel = document.getElementById('current-page');
    const prevBtn = document.getElementById('prev-btn');
    const resetBtn = document.querySelector('[data-reset-filters]');
    const pageButtons = document.querySelectorAll('[data-page-shift]');
    const hx = window.htmx;
    let filterTimer = null;

    function updatePaginationControls() {
        const limit = Number(limitInput?.value) || 1;
        const offset = Number(offsetInput?.value) || 0;
        const currentPage = Math.floor(offset / limit) + 1;
        if (pageLabel) {
            pageLabel.textContent = currentPage;
        }
        if (prevBtn) {
            prevBtn.disabled = offset === 0;
        }
    }

    function triggerRefresh(eventName) {
        if (!container || !hx) {
            return;
        }
        hx.trigger(container, eventName || 'refresh');
    }

    function shiftPage(deltaPages) {
        const limit = Number(limitInput?.value) || 100;
        const offset = Number(offsetInput?.value) || 0;
        const nextOffset = Math.max(0, offset + deltaPages * limit);
        if (nextOffset === offset && nextOffset === 0 && deltaPages < 0) {
            return;
        }
        offsetInput.value = String(nextOffset);
        updatePaginationControls();
        triggerRefresh('refresh');
    }

    pageButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const delta = Number(button.dataset.pageShift) || 0;
            shiftPage(delta);
        });
    });

    function scheduleFilterRefresh() {
        if (!offsetInput) {
            return;
        }
        offsetInput.value = '0';
        updatePaginationControls();
        if (filterTimer) {
            window.clearTimeout(filterTimer);
        }
        filterTimer = window.setTimeout(() => triggerRefresh('filters-changed'), 250);
    }

    filterForm?.addEventListener('input', scheduleFilterRefresh);
    filterForm?.addEventListener('change', scheduleFilterRefresh);

    resetBtn?.addEventListener('click', () => {
        filterForm?.reset();
        scheduleFilterRefresh();
    });

    document.addEventListener('htmx:configRequest', (event) => {
        if (event.target !== container) {
            return;
        }
        const params = event.detail?.parameters;
        if (!params) {
            return;
        }
        ['start', 'end'].forEach((key) => {
            if (params[key]) {
                const normalized = normalizeDateValue(params[key]);
                if (normalized) {
                    params[key] = normalized;
                } else {
                    delete params[key];
                }
            }
        });
    });

    function normalizeDateValue(value) {
        if (!value) {
            return '';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return '';
        }
        return date.toISOString();
    }

    updatePaginationControls();
});
</script>
{{end}}
