{{template "base.html" .}}

{{define "title"}}Policies - Gloryhole{{end}}

{{define "content"}}
<div class="policies-page">
    <div class="page-header">
        <h2>DNS Policies</h2>
        <div class="policy-actions">
            <a class="btn btn-secondary" href="/api/policies/export" download>
                Export Policies
            </a>
            <button class="btn btn-primary" type="button" onclick="showAddPolicyModal()">
                Add Policy
            </button>
        </div>
    </div>

    {{$cfg := .Config}}
    <div class="policies-info">
        <p>Policies allow you to define advanced filtering rules based on time, client IP, and domain patterns.</p>
        <div class="status-grid">
            <div class="status-card">
                <h4>Policy Engine</h4>
                <p class="status-text">{{if $cfg.Server.EnablePolicies}}Enabled{{else}}Disabled via kill-switch{{end}}</p>
            </div>
            <div class="status-card">
                <h4>Rules Loaded</h4>
                <p class="status-text">{{len $cfg.Policy.Rules}}</p>
            </div>
        </div>
    </div>

    <!-- Quick Add Section -->
    <div class="quick-add-section">
        <h3>Quick Add Domain Rule</h3>
        <form id="quick-add-form" onsubmit="submitQuickAdd(event)" class="quick-add-form">
            <div class="quick-add-row">
                <div class="form-group">
                    <label for="quick-domain">Domain</label>
                    <input type="text" id="quick-domain" name="domain" required
                           placeholder="example.com or *.example.com">
                </div>
                <div class="form-group">
                    <label for="quick-action">Action</label>
                    <select id="quick-action" name="action">
                        <option value="ALLOW">Allow (bypass blocklist)</option>
                        <option value="BLOCK">Block (return NXDOMAIN)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="quick-wildcard" name="wildcard">
                        <span>Wildcard (*.domain)</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Add Rule</button>
            </div>
            <small class="form-help">
                Quick add creates a simple domain-based policy. For advanced rules with time/IP conditions, use "Add Policy" above.
            </small>
        </form>
    </div>

    <!-- Policies List -->
    <div id="policies-container"
         hx-get="/api/policies"
         hx-trigger="load, policy-updated from:body"
         hx-swap="innerHTML">
        <div class="loading">Loading policies...</div>
    </div>
</div>

<!-- Add/Edit Policy Modal -->
<div id="policy-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Add Policy</h3>
            <button class="modal-close" onclick="closePolicyModal()">&times;</button>
        </div>
        <form id="policy-form" onsubmit="submitPolicy(event)">
            <input type="hidden" id="policy-id" name="id">

            <div class="form-group">
                <label for="policy-name">Policy Name *</label>
                <input type="text" id="policy-name" name="name" required
                       placeholder="e.g., Block Social Media After Hours">
            </div>

            <div class="logic-mode-toggle">
                <label>
                    <input type="radio" name="logic-mode" value="builder" checked>
                    Guided builder
                </label>
                <label>
                    <input type="radio" name="logic-mode" value="expression">
                    Advanced expression
                </label>
            </div>

            <div id="builder-panel" class="builder-panel">
                <div class="builder-row">
                    <select id="builder-field" class="filter-select"></select>
                    <select id="builder-operator" class="filter-select"></select>
                    <input type="text" id="builder-value" class="filter-input" placeholder="Value">
                    <select id="builder-value-select" class="filter-select" style="display:none;"></select>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addPolicyCondition()">Add</button>
                </div>
                <div class="builder-row">
                    <label>Match
                        <select id="builder-combinator" class="filter-select builder-combinator">
                            <option value="&&">ALL conditions</option>
                            <option value="||">ANY condition</option>
                        </select>
                    </label>
                </div>
                <div id="builder-conditions" class="builder-conditions empty">
                    No conditions yet. Select a field above to begin.
                </div>
            </div>

            <div class="form-group">
                <label for="policy-logic">Rule Logic *</label>
                <textarea id="policy-logic" name="logic" required rows="4"
                          placeholder="e.g., Hour >= 22 && DomainMatches(Domain, 'facebook.com')"></textarea>
                <small class="form-help">
                    Switch to <strong>Advanced expression</strong> mode to edit this field manually.<br>
                    Available context: Hour, Minute, Day, Month, Weekday, Domain, ClientIP, QueryType<br>
                    Helper functions: DomainMatches(), DomainEndsWith(), DomainStartsWith(), IPInCIDR(), QueryTypeIn()
                </small>
            </div>

            <div class="form-group">
                <label for="policy-action">Action *</label>
                <select id="policy-action" name="action" required>
                    <option value="BLOCK">BLOCK - Return NXDOMAIN</option>
                    <option value="ALLOW">ALLOW - Bypass blocklist</option>
                    <option value="REDIRECT">REDIRECT - Redirect to IP address</option>
                    <option value="FORWARD">FORWARD - Use custom upstreams</option>
                </select>
            </div>

            <div class="form-group">
                <label for="policy-action-data">Action Data</label>
                <input type="text" id="policy-action-data" name="action_data"
                       placeholder="e.g., 0.0.0.0 or 1.1.1.1:53,8.8.8.8:53">
                <small class="form-help">
                    <strong>For REDIRECT:</strong> IP address to redirect to (e.g., 0.0.0.0)<br>
                    <strong>For FORWARD:</strong> Custom upstream DNS servers (e.g., 1.1.1.1:53,8.8.8.8:53)
                </small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="policy-enabled" name="enabled" checked>
                    <span>Enable this policy</span>
                </label>
            </div>

            <div class="form-group">
                <label>Rule Tester</label>
                <div class="policy-tester">
                    <input type="text" id="policy-test-domain" placeholder="Domain (example.com)" class="filter-input">
                    <input type="text" id="policy-test-client" placeholder="Client IP (optional)" class="filter-input">
                    <select id="policy-test-type" class="filter-select">
                        <option value="A">A</option>
                        <option value="AAAA">AAAA</option>
                        <option value="CNAME">CNAME</option>
                        <option value="MX">MX</option>
                    </select>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="testPolicyRule()">Test Rule</button>
                </div>
                <p id="policy-test-result" class="text-muted small-text"></p>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePolicyModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Policy</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
import { initPolicyModule } from '/static/js/modules/policies.js';
document.addEventListener('DOMContentLoaded', initPolicyModule);
</script>
{{end}}
