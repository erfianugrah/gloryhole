# Glory-Hole DNS Server Configuration

# Server settings
server:
  listen_address: ":53"
  tcp_enabled: true
  udp_enabled: true
  web_ui_address: ":8080"
  decision_trace: false    # Capture detailed block breadcrumbs (higher storage cost)

# Optional per-client rate limiting
rate_limit:
  enabled: false
  requests_per_second: 100
  burst: 200
  on_exceed: "nxdomain"  # drop or nxdomain
  log_violations: true
  cleanup_interval: "10m"
  max_tracked_clients: 10000
  overrides:
    - name: "kids"
      clients:
        - "192.168.1.120"
        - "192.168.1.121"
      requests_per_second: 25
      burst: 50
      on_exceed: "drop"
    - name: "iot-network"
      cidrs:
        - "192.168.10.0/24"
      requests_per_second: 5
      burst: 10

# Upstream DNS servers
upstream_dns_servers:
  - "1.1.1.1:53"
  - "8.8.8.8:53"

# Update settings
update_interval: "24h"
auto_update_blocklists: true

# Blocklists
blocklists:
  - "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"

# Whitelist
whitelist:
  - "example-allowed-domain.com"

# Local DNS Records
# Define custom DNS responses for specific domains
# Features: Multiple IPs, AAAA records, wildcards, CNAME records, custom TTLs
local_records:
  enabled: true
  records:
    # A record with single IPv4 address
    - domain: "nas.local"
      type: "A"
      ips:
        - "192.168.1.100"
      ttl: 300  # optional, defaults to 300

    # A record with multiple IPs (round-robin)
    - domain: "server.local"
      type: "A"
      ips:
        - "192.168.1.10"
        - "192.168.1.11"
        - "192.168.1.12"

    # AAAA record for IPv6
    - domain: "server.local"
      type: "AAAA"
      ips:
        - "fe80::1"
        - "fe80::2"

    # CNAME record
    - domain: "storage.local"
      type: "CNAME"
      target: "nas.local"

    # Wildcard record (matches *.dev.local)
    # Note: Only matches one level (server.dev.local, NOT sub.server.dev.local)
    - domain: "*.dev.local"
      type: "A"
      wildcard: true
      ips:
        - "192.168.1.200"

    # TXT record (SPF, DKIM, domain verification)
    - domain: "example.local"
      type: "TXT"
      txt:
        - "v=spf1 include:_spf.example.com ~all"
        - "google-site-verification=abc123def456"
      ttl: 300

    # MX record (mail exchange with priority)
    - domain: "example.local"
      type: "MX"
      target: "mail.example.local"
      priority: 10
      ttl: 300

    - domain: "example.local"
      type: "MX"
      target: "backup-mail.example.local"
      priority: 20

    # PTR record (reverse DNS)
    - domain: "100.1.168.192.in-addr.arpa"
      type: "PTR"
      target: "nas.local"
      ttl: 300

    # SRV record (service discovery)
    - domain: "_ldap._tcp.example.local"
      type: "SRV"
      target: "dc1.example.local"
      priority: 0
      weight: 100
      port: 389
      ttl: 300

    # NS record (nameserver delegation)
    - domain: "subdomain.example.local"
      type: "NS"
      target: "ns1.example.local"
      ttl: 86400

    # SOA record (Start of Authority)
    - domain: "example.local"
      type: "SOA"
      ns: "ns1.example.local"
      mbox: "admin.example.local"
      serial: 2023010101
      refresh: 3600
      retry: 600
      expire: 86400
      minttl: 300
      ttl: 86400

    # CAA record (Certificate Authority Authorization)
    - domain: "example.com"
      type: "CAA"
      caa_tag: "issue"
      caa_value: "letsencrypt.org"
      caa_flag: 0
      ttl: 300

    - domain: "example.com"
      type: "CAA"
      caa_tag: "issuewild"
      caa_value: "letsencrypt.org"
      caa_flag: 0

    - domain: "example.com"
      type: "CAA"
      caa_tag: "iodef"
      caa_value: "mailto:security@example.com"
      caa_flag: 0

# Database (Query Logging & Statistics)
database:
  enabled: true
  backend: "sqlite"              # sqlite or d1 (cloudflare)

  # SQLite configuration
  sqlite:
    path: "./glory-hole.db"
    busy_timeout: 5000           # milliseconds
    wal_mode: true               # write-ahead logging for better concurrency
    cache_size: 10000            # KB

  # D1 configuration (Cloudflare edge database)
  d1:
    account_id: ""               # Cloudflare account ID
    database_id: ""              # D1 database ID
    api_token: ""                # Cloudflare API token with D1 access

  # Buffer settings (async writes for performance)
  buffer_size: 1000              # queries to buffer before flush
  flush_interval: "5s"           # how often to flush buffer
  batch_size: 100                # max queries per batch insert

  # Retention policy
  retention_days: 7              # days to keep detailed logs

  # Statistics aggregation
  statistics:
    enabled: true
    aggregation_interval: "1h"   # hourly rollups

# Cache
cache:
  enabled: true
  max_entries: 10000
  min_ttl: "60s"
  max_ttl: "24h"
  negative_ttl: "5m"  # TTL for upstream NXDOMAIN responses
  blocked_ttl: "1s"    # TTL for blocked domain responses (reduces repeated blocking logic)

# Logging
logging:
  level: "info"          # debug, info, warn, error
  format: "text"         # json, text
  output: "stdout"       # stdout, stderr, file
  add_source: true       # include file:line in logs (great for debugging, adds ~1-2Î¼s overhead per log)
  file_path: ""          # required if output=file
  max_size: 100          # MB
  max_backups: 3
  max_age: 7             # days

# Conditional Forwarding (Route queries to different upstream servers)
# Use this for split-DNS setups, VPN routing, or domain-specific nameservers
conditional_forwarding:
  enabled: false
  rules:
    # Forward local domain queries to internal DNS server
    - name: "Local domains"
      priority: 90                    # Higher priority = evaluated first
      domains:
        - "*.local"                   # Wildcard suffix match
        - "*.lan"
        - "home.arpa"                 # Exact match
      upstreams:
        - "192.168.1.1:53"           # Internal DNS server
        - "192.168.1.2:53"           # Backup internal DNS
      enabled: true

    # Forward VPN client queries to corporate DNS
    - name: "VPN clients to corporate DNS"
      priority: 80
      client_cidrs:
        - "10.8.0.0/24"              # VPN subnet
      domains:
        - "*.corp.example.com"       # Corporate domains
        - "*.internal"
      upstreams:
        - "10.0.0.53:53"             # Corporate DNS
      enabled: true

    # Forward reverse DNS (PTR) queries to local network DNS
    - name: "Reverse DNS"
      priority: 70
      query_types:
        - "PTR"                      # DNS reverse lookups
      domains:
        - "*.in-addr.arpa"           # IPv4 reverse DNS
        - "*.ip6.arpa"               # IPv6 reverse DNS
      upstreams:
        - "192.168.1.1:53"
      enabled: true

    # Combined rule: VPN clients accessing local domains (high priority)
    - name: "VPN clients to local domains"
      priority: 95                   # Highest priority
      domains:
        - "*.local"
      client_cidrs:
        - "10.8.0.0/24"
      query_types:
        - "A"
        - "AAAA"
      upstreams:
        - "192.168.1.1:53"
      enabled: true

    # Forward specific company domains to authoritative server
    - name: "Example Corp authoritative"
      priority: 50
      domains:
        - "example.com"
        - "*.example.com"
      upstreams:
        - "ns1.example.com:53"
        - "ns2.example.com:53"
      enabled: false

# Policy Engine (Advanced Rule-Based Filtering)
# NOTE: Policy rules with action: FORWARD can also do conditional forwarding
# Use conditional_forwarding (above) for simple domain/IP-based routing
# Use policy engine (below) for complex logic with expressions
policy:
  enabled: true
  rules:
    # Block social media during work hours (9 AM - 5 PM)
    - name: "Block social media during work hours"
      logic: 'Hour >= 9 && Hour < 17 && (DomainMatches(Domain, "facebook") || DomainMatches(Domain, "twitter") || DomainMatches(Domain, "instagram"))'
      action: "block"
      enabled: true

    # Allow specific internal network ranges
    - name: "Allow internal network"
      logic: 'IPInCIDR(ClientIP, "192.168.1.0/24") || IPInCIDR(ClientIP, "10.0.0.0/8")'
      action: "allow"
      enabled: true

    # Block gambling sites
    - name: "Block gambling"
      logic: 'DomainMatches(Domain, "casino") || DomainMatches(Domain, "poker") || DomainMatches(Domain, "betting")'
      action: "block"
      enabled: true

    # Forward internal queries from VPN clients to corporate DNS
    # This uses the policy engine for complex conditional forwarding
    - name: "VPN clients to corporate DNS (policy-based)"
      logic: 'IPInCIDR(ClientIP, "10.8.0.0/24") && (DomainMatches(Domain, ".local") || DomainMatches(Domain, ".internal"))'
      action: "forward"
      action_data: "192.168.1.1:53,192.168.1.2:53"  # Comma-separated upstream list
      enabled: false  # Example only

    # Block after hours (outside 6 AM - 11 PM)
    - name: "Block after hours"
      logic: 'Hour < 6 || Hour >= 23'
      action: "block"
      enabled: false  # disabled by default

# Telemetry (OpenTelemetry)
telemetry:
  enabled: true
  service_name: "glory-hole"
  service_version: "dev"
  prometheus_enabled: true
  prometheus_port: 9090
  tracing_enabled: false
  tracing_endpoint: ""
